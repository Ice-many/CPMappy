<!DOCTYPE html>
<html>
<head>
  <title>Carte interactive codes postaux France</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Feuille de style Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <!-- Librairie SheetJS pour lire Excel -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    body { margin:0; padding:0; }
    #map { height: 90vh; width: 100vw; }
    #controls {
      padding:10px; background:#fff; position: fixed; top:8px; left:8px; z-index: 1000;
      border-radius: 6px; box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }
    /* Style tooltip personnalisée */
    .custom-tooltip {
      font-weight: bold;
    }
    /* Contrôle zoom avec affichage de valeur */
    .leaflet-control-zoom-level {
      background: #fff;
      padding: 6px 10px;
      font-size: 14px;
      font-family: Arial, sans-serif;
      color: #333;
    }
  </style>
</head>
<body>
  <div id="controls">
    <input type="file" id="uploadExcel" accept=".xlsx" />
    <button id="convertBtn">Conversion JSON et Affichage</button>
  </div>
  <div id="map"></div>
  <script>
    // Initialisation de la carte avec minZoom fixé à 5
    var map = L.map('map', { minZoom: 5 }).setView([46.6, 2.4], 6);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18,
      attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    // Contrôle personnalisé affichant la valeur du zoom
    var ZoomLevelControl = L.Control.extend({
      onAdd: function(map) {
        var container = L.DomUtil.create('div', 'leaflet-control-zoom-level');
        container.innerHTML = 'Zoom: ' + map.getZoom();
        this._container = container;
        return container;
      },
      updateZoom: function(zoom) {
        this._container.innerHTML = 'Zoom: ' + zoom;
      }
    });

    var zoomLevelControl = new ZoomLevelControl({ position: 'topleft' });
    zoomLevelControl.addTo(map);

    // Mettre à jour la valeur de zoom à chaque changement
    map.on('zoomend', function() {
      zoomLevelControl.updateZoom(map.getZoom());
    });

    let extraProperties = {};

    function getKeyIgnoreCase(obj, key) {
      key = key.toLowerCase().replace(/\s+/g, '');
      for (const k in obj) {
        if (k.toLowerCase().replace(/\s+/g, '') === key) return obj[k];
      }
      return null;
    }

    function updateMapWithExtraProperties() {
      fetch('contours-codes-postaux.geojson')
        .then(res => {
          if (!res.ok) throw new Error("Le fichier GeoJSON n'a pas été chargé correctement.");
          return res.json();
        })
        .then(data => {
          if (window.geoLayer) map.removeLayer(window.geoLayer);

          window.geoLayer = L.geoJSON(data, {
            style: function(feature) {
              let cp = feature.properties.code_postal || feature.properties.codePostal || feature.properties.code || "";
              let extras = extraProperties[cp] || {};

              return {
                fillColor: getKeyIgnoreCase(extras, "Fond_couleur") || "#66cc66",
                color: getKeyIgnoreCase(extras, "Ligne_couleur") || "#000000",
                weight: 1,
                opacity: 1,
                fillOpacity: 0.7
              };
            },
            onEachFeature: function(feature, layer) {
              let cp = feature.properties.code_postal || feature.properties.codePostal || feature.properties.code || "";
              let extras = extraProperties[cp] || {};

              let texteParts = [];
              ["Texte1", "Texte2", "Texte3", "Texte4"].forEach(field => {
                let val = getKeyIgnoreCase(extras, field);
                if (val) texteParts.push(val);
              });

              let tooltipText = texteParts.join(" ");

              let policeCouleur = getKeyIgnoreCase(extras, "police couleur") || '#000000';

              layer.bindTooltip(
                `<span style="color: ${policeCouleur};">${tooltipText || ("Code Postal : " + cp)}</span>`,
                {className: 'custom-tooltip'}
              );

              let clicUrl = getKeyIgnoreCase(extras, "Clic URL");
              if (clicUrl && clicUrl.trim().length > 0) {
                layer.on("click", function() {
                  window.open(clicUrl, '_blank');
                });
                layer.setStyle({ cursor: "pointer" });
              }
            }
          }).addTo(map);

          map.fitBounds(window.geoLayer.getBounds());
        })
        .catch(err => {
          alert(err.message);
          console.error(err);
        });
    }

    document.getElementById('convertBtn').onclick = function() {
      let fileInput = document.getElementById('uploadExcel');
      let file = fileInput.files[0];
      if (!file) {
        alert("Sélectionnez un fichier Excel (.xlsx) à convertir avant de cliquer.");
        return;
      }
      var reader = new FileReader();
      reader.onload = function(e) {
        var data = new Uint8Array(e.target.result);
        var workbook = XLSX.read(data, {type: 'array'});
        var firstSheetName = workbook.SheetNames[0];
        var sheet = workbook.Sheets[firstSheetName];
        var jsonData = XLSX.utils.sheet_to_json(sheet);
        extraProperties = {};
        jsonData.forEach(function(item) {
          let cp = (item["Code Postal"] || "").toString();
          if (cp.length > 0) extraProperties[cp] = item;
        });
        updateMapWithExtraProperties();
        alert("Conversion et affichage réalisés !");
      };
      reader.readAsArrayBuffer(file);
    };
  </script>
</body>
</html>
