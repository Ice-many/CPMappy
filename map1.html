<!DOCTYPE html>
<html>
<head>
  <title>Carte interactive codes postaux France</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    html, body {
      margin: 0; padding: 0; height: 100%;
      font-family: Arial, sans-serif;
      overflow: hidden;
    }
    body {
      display: flex;
      height: 100vh;
      user-select: none;
    }
    #sidebar-left, #sidebar-right {
      background: #000; /* fond noir */
      color: white;
      overflow-y: auto;
      padding: 10px;
      box-shadow: 2px 0 5px rgba(0,0,0,0.3);
      font-size: 14px;
      min-width: 180px;
      max-width: 400px;
      resize: horizontal;
      overflow: auto;
    }
    #sidebar-left {
      border-right: 1px solid #444;
      width: 280px;
    }
    #sidebar-right {
      border-left: 1px solid #444;
      width: 250px;
    }
    #map {
      flex-grow: 1;
      height: 100vh;
    }
    label {
      display: block;
      margin-bottom: 6px;
      cursor: pointer;
      user-select: text;
      color: white;
    }
    #controls {
      padding: 10px;
      background: #111;
      position: sticky;
      top: 0;
      z-index: 1000;
      border-bottom: 1px solid #444;
      margin-bottom: 10px;
      user-select: none;
      color: white;
    }
    .custom-tooltip {
      font-weight: bold;
    }
    .selectall-label {
      font-weight: bold;
      margin: 0 0 8px 0;
      cursor: pointer;
      user-select: none;
      color: white;
      display: flex;
      align-items: center;
    }
    .selectall-label input {
      margin-right: 8px;
    }
    .toggle-btn {
      font-size: 14px;
      background: #007bff;
      border: none;
      color: white;
      padding: 6px 10px;
      border-radius: 4px;
      cursor: pointer;
      user-select: none;
      margin: 10px 0 4px 0;
      width: 100%;
      text-align: left;
    }
    #toggleLeftBtn, #toggleRightBtn {
      position: fixed;
      top: 10px;
      padding: 8px 14px;
      font-size: 14px;
      border-radius: 4px;
      cursor: pointer;
      z-index: 1300;
      user-select: none;
      background-color: #6a0dad; /* violet */
      color: white;
      box-shadow: 0 2px 8px rgba(106,13,173,0.7);
      transition: background-color 0.3s ease;
    }
    #toggleLeftBtn.active, #toggleRightBtn.active {
      background-color: #00bfff;
      box-shadow: 0 2px 8px rgba(0,191,255,0.7);
    }
    #toggleLeftBtn { left: 10px; }
    #toggleRightBtn { right: 10px; }
    .hidden { display: none !important; }
  </style>
</head>
<body>
  <button id="toggleLeftBtn" title="Afficher/Masquer Réseau">Réseau</button>
  <button id="toggleRightBtn" title="Afficher/Masquer Département">Département</button>

  <div id="sidebar-left">
    <div id="controls">
      <input type="file" id="uploadExcel" accept=".xlsx" />
      <button id="convertBtn">Conversion et Affichage</button>
    </div>

    <button class="toggle-btn" data-target="agence">Agence</button>
    <div id="filter-agence" class="hidden">
      <label class="selectall-label"><input type="checkbox" id="agence-select-all" /> Tout</label>
      <div id="agenceList"></div>
    </div>

    <button class="toggle-btn" data-target="region">Région</button>
    <div id="filter-region" class="hidden">
      <label class="selectall-label"><input type="checkbox" id="region-select-all" /> Tout</label>
      <div id="regionList"></div>
    </div>

    <button class="toggle-btn" data-target="antenne">Antenne</button>
    <div id="filter-antenne" class="hidden">
      <label class="selectall-label"><input type="checkbox" id="antenne-select-all" /> Tout</label>
      <div id="antenneList"></div>
    </div>

    <button class="toggle-btn" data-target="dsp">DSP</button>
    <div id="filter-dsp" class="hidden">
      <label class="selectall-label"><input type="checkbox" id="dsp-select-all" /> Tout</label>
      <div id="dspList"></div>
    </div>
  </div>

  <div id="map"></div>

  <div id="sidebar-right">
    <button class="toggle-btn" data-target="departement">Département</button>
    <div id="filter-departement" class="hidden">
      <label class="selectall-label"><input type="checkbox" id="departement-select-all" /> Tout</label>
      <div id="departementList"></div>
    </div>

    <button class="toggle-btn" data-target="texte2">Texte2</button>
    <div id="filter-texte2" class="hidden">
      <label class="selectall-label"><input type="checkbox" id="texte2-select-all" /> Tout</label>
      <div id="texte2List"></div>
    </div>
  </div>

<script>
  var map = L.map('map', { minZoom: 6, center: [46.5, 2.5], zoom: 6 });

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18,
      attribution: '© OpenStreetMap contributors'
  }).addTo(map);

  let extraProperties = {};
  let geoLayer;

  let distinctValues = {
    agence: new Map(),
    region: new Map(),
    antenne: new Map(),
    dsp: new Map(),
    departement: new Map(),
    texte2: new Map()
  };

  let filterState = {
    agence: new Map(),
    region: new Map(),
    antenne: new Map(),
    dsp: new Map(),
    departement: new Map(),
    texte2: new Map()
  };

  function getValueCaseInsensitive(obj, key) {
    if (!obj) return "";
    key = key.toLowerCase().replace(/\s+/g, '');
    for (let k in obj) {
      if (k.toLowerCase().replace(/\s+/g, '') === key)
        return obj[k];
    }
    return "";
  }

  function buildFilterList(filterName, containerId) {
    const container = document.getElementById(containerId);
    container.innerHTML = "";
    const mapvals = distinctValues[filterName];
    if (!mapvals) return;

    const vals = Array.from(mapvals.keys());
    vals.sort((a,b) => a.localeCompare(b,undefined,{ignorePunctuation:true}));
    vals.forEach(val => {
      const setCP = mapvals.get(val);
      const label = document.createElement("label");
      label.className = "filter-option";
      label.title = `${setCP.size} codes postaux`;
      const checkbox = document.createElement("input");
      checkbox.type = "checkbox";
      checkbox.checked = true;
      filterState[filterName].set(val,true);
      checkbox.addEventListener("change", () => {
        filterState[filterName].set(val, checkbox.checked);
        updateSelectAll(filterName);
        filterMap();
      });
      label.appendChild(checkbox);
      label.appendChild(document.createTextNode(" " + val));
      container.appendChild(label);
    });
  }

  function updateSelectAll(filterName) {
    const selectAll = document.getElementById(filterName + "-select-all");
    if (!selectAll) return;
    const vals = Array.from(filterState[filterName].values());
    const allChecked = vals.length > 0 && vals.every(v => v === true);
    selectAll.checked = allChecked;
    selectAll.indeterminate = !allChecked && vals.some(v => v === true);
  }

  function setupSelectAllListener(filterName) {
    const selectAll = document.getElementById(filterName + "-select-all");
    if (!selectAll) return;
    selectAll.addEventListener("change", () => {
      const checked = selectAll.checked;
      filterState[filterName].forEach((_, key) => filterState[filterName].set(key, checked));
      const container = document.getElementById(filterName + "List");
      if (container) {
        container.querySelectorAll("input[type=checkbox]").forEach(cb => cb.checked = checked);
      }
      filterMap();
    });
  }

  function setupToggleButtons() {
    document.querySelectorAll(".toggle-btn").forEach(btn => {
      const target = btn.getAttribute("data-target");
      btn.textContent = target.charAt(0).toUpperCase() + target.slice(1);
      btn.addEventListener("click", () => {
        const filterDiv = document.getElementById("filter-" + target);
        if (!filterDiv) return;
        if (filterDiv.classList.contains("hidden")) {
          filterDiv.classList.remove("hidden");
          btn.textContent = "Masquer " + target.charAt(0).toUpperCase() + target.slice(1);
        } else {
          filterDiv.classList.add("hidden");
          btn.textContent = target.charAt(0).toUpperCase() + target.slice(1);
        }
      });
    });
  }

  document.getElementById("toggleLeftBtn").addEventListener("click", function(){
    const sidebar = document.getElementById("sidebar-left");
    const btn = this;
    if(sidebar.style.display === "none"){
      sidebar.style.display = "block";
      btn.classList.remove("active");
      btn.style.backgroundColor = "#6a0dad";
      btn.style.boxShadow = "0 2px 8px rgba(106,13,173,0.7)";
    } else {
      sidebar.style.display = "none";
      btn.classList.add("active");
      btn.style.backgroundColor = "#00bfff";
      btn.style.boxShadow = "0 2px 8px rgba(0,191,255,0.7)";
    }
  });

  document.getElementById("toggleRightBtn").addEventListener("click", function(){
    const sidebar = document.getElementById("sidebar-right");
    const btn = this;
    if(sidebar.style.display === "none"){
      sidebar.style.display = "block";
      btn.classList.remove("active");
      btn.style.backgroundColor = "#6a0dad";
      btn.style.boxShadow = "0 2px 8px rgba(106,13,173,0.7)";
    } else {
      sidebar.style.display = "none";
      btn.classList.add("active");
      btn.style.backgroundColor = "#00bfff";
      btn.style.boxShadow = "0 2px 8px rgba(0,191,255,0.7)";
    }
  });

  function filterMap(){
    if (!geoLayer) return;
    geoLayer.eachLayer(layer => {
      const cp = layer.feature.properties.code_postal || layer.feature.properties.codePostal || layer.feature.properties.code || "";
      const extras = extraProperties[cp];
      if(!extras){
        if(layer._map) layer.remove();
        return;
      }
      const valAgence = getValueCaseInsensitive(extras,"Agence");
      const valRegion = getValueCaseInsensitive(extras,"région");
      const valAntenne = getValueCaseInsensitive(extras,"Antenne");
      const valDepartement = getValueCaseInsensitive(extras,"Departement");
      const valTexte2 = getValueCaseInsensitive(extras,"Texte2");
      
      let visible = true;
      visible = visible && (filterState.agence.get(valAgence) !== false);
      visible = visible && (filterState.region.get(valRegion) !== false);
      visible = visible && (filterState.antenne.get(valAntenne) !== false);
      visible = visible && (filterState.departement.get(valDepartement) !== false);
      visible = visible && (filterState.texte2.get(valTexte2) !== false);

      if(visible){
        if(!layer._map) layer.addTo(map);
      } else {
        if(layer._map) layer.remove();
      }
    });
  }

  function getValueCaseInsensitive(obj,key){
    if(!obj) return "";
    key = key.toLowerCase().replace(/\s+/g,"");
    for(let k in obj){
      if(k.toLowerCase().replace(/\s+/g,"") === key)
        return obj[k];
    }
    return "";
  }

  function updateDistinctFilters(data){
    Object.keys(distinctValues).forEach(k=>{
      distinctValues[k].clear();
      filterState[k].clear();
    });
    data.forEach(item=>{
      const cp = (item["Code Postal"] || "").toString();
      if(!cp) return;
      const ag = getValueCaseInsensitive(item,"Agence");
      const re = getValueCaseInsensitive(item,"région");
      const an = getValueCaseInsensitive(item,"Antenne");
      const dep = getValueCaseInsensitive(item,"Departement");
      const t2 = getValueCaseInsensitive(item,"Texte2");

      if(ag) distinctValues.agence.set(ag,(distinctValues.agence.get(ag) || new Set()).add(cp));
      if(re) distinctValues.region.set(re,(distinctValues.region.get(re) || new Set()).add(cp));
      if(an) distinctValues.antenne.set(an,(distinctValues.antenne.get(an) || new Set()).add(cp));
      if(dep) distinctValues.departement.set(dep,(distinctValues.departement.get(dep) || new Set()).add(cp));
      if(t2) distinctValues.texte2.set(t2,(distinctValues.texte2.get(t2) || new Set()).add(cp));
    });
  }

  function buildFilters(){
    Object.keys(distinctValues).forEach(key=>{
      buildFilterList(key,key+"List");
      updateSelectAll(key);
      setupSelectAllListener(key);
    });
  }

  function buildFilterList(filterName,containerId){
    const container = document.getElementById(containerId);
    container.innerHTML="";
    const vals = distinctValues[filterName];
    if(!vals) return;
    const keys = Array.from(vals.keys()).sort((a,b)=>a.localeCompare(b));
    keys.forEach(k=>{
      const setValues = vals.get(k);
      const label = document.createElement('label');
      label.title=`${setValues.size} codes postaux`;
      const cb = document.createElement('input');
      cb.type = 'checkbox'; cb.checked = true;
      filterState[filterName].set(k,true);
      cb.addEventListener('change',()=> {
        filterState[filterName].set(k,cb.checked);
        updateSelectAll(filterName);
        filterMap();
      });
      label.appendChild(cb);
      label.appendChild(document.createTextNode(" "+k));
      container.appendChild(label);
    })
  }

  document.getElementById('toggleLeftBtn').addEventListener('click',function(){
    const sidebar = document.getElementById('sidebar-left');
    const btn=this;
    if(sidebar.style.display==='none'){
      sidebar.style.display='block';
      btn.classList.remove('active');
      btn.style.backgroundColor='#6a0dad';
      btn.style.boxShadow='0 2px 8px rgba(106,13,173,0.7)';
    } else {
      sidebar.style.display='none';
      btn.classList.add('active');
      btn.style.backgroundColor='#00bfff';
      btn.style.boxShadow='0 2px 8px rgba(0,191,255,0.7)';
    }
  });

  document.getElementById('toggleRightBtn').addEventListener('click',function(){
    const sidebar=document.getElementById('sidebar-right');
    const btn=this;
    if(sidebar.style.display==='none'){
      sidebar.style.display='block';
      btn.classList.remove('active');
      btn.style.backgroundColor='#6a0dad';
      btn.style.boxShadow='0 2px 8px rgba(106,13,173,0.7)';
    } else {
      sidebar.style.display='none';
      btn.classList.add('active');
      btn.style.backgroundColor='#00bfff';
      btn.style.boxShadow='0 2px 8px rgba(0,191,255,0.7)';
    }
  });

  function setupToggleButtons(){
    document.querySelectorAll('.toggle-btn').forEach(btn=>{
      const target=btn.getAttribute('data-target');
      btn.textContent=target.charAt(0).toUpperCase()+target.slice(1);
      btn.addEventListener('click',()=>{
        const filterDiv=document.getElementById('filter-'+target);
        if(!filterDiv) return;
        if(filterDiv.classList.contains('hidden')){
          filterDiv.classList.remove('hidden');
          btn.textContent='Masquer '+target.charAt(0).toUpperCase()+target.slice(1);
        } else {
          filterDiv.classList.add('hidden');
          btn.textContent=target.charAt(0).toUpperCase()+target.slice(1);
        }
      })
    });
  }

  document.getElementById('convertBtn').addEventListener('click',function(){
    const fileInput=document.getElementById('uploadExcel');
    if(fileInput.files.length ===0){
      alert('Veuillez sélectionner un fichier Excel (.xlsx).');
      return;
    }
    const reader=new FileReader();
    reader.onload=function(e){
      const data=new Uint8Array(e.target.result);
      const workbook=XLSX.read(data,{type:'array'});
      const firstSheet=workbook.SheetNames[0];
      const json=XLSX.utils.sheet_to_json(workbook.Sheets[firstSheet]);

      extraProperties={};
      json.forEach(item=>{
        const cp=(item['Code Postal'] || '').toString();
        if(cp) extraProperties[cp]=item;
      });

      // Ajout DSP dans distinctValues et filterState si non existants
      if(!('dsp' in distinctValues)){
        distinctValues['dsp']=new Map();
      }
      if(!('dsp' in filterState)){
        filterState['dsp']=new Map();
      }

      // Remplissage des distinct values y compris DSP
      distinctValues = {
        agence: new Map(),
        region: new Map(),
        antenne: new Map(),
        dsp: new Map(),
        departement: new Map(),
        texte2: new Map()
      };

      json.forEach(row=>{
        const cp=(row['Code Postal'] || '').toString();
        if(!cp) return;
        const ag = getValueCaseInsensitive(row,'Agence');
        const rg = getValueCaseInsensitive(row,'région');
        const an = getValueCaseInsensitive(row,'Antenne');
        const dsp = getValueCaseInsensitive(row,'DSP');
        const dep = getValueCaseInsensitive(row,'Departement');
        const t2 = getValueCaseInsensitive(row,'Texte2');

        if(ag) {
          if(!distinctValues.agence.has(ag)) distinctValues.agence.set(ag,new Set());
          distinctValues.agence.get(ag).add(cp);
        }
        if(rg){
          if(!distinctValues.region.has(rg)) distinctValues.region.set(rg,new Set());
          distinctValues.region.get(rg).add(cp);
        }
        if(an){
          if(!distinctValues.antenne.has(an)) distinctValues.antenne.set(an,new Set());
          distinctValues.antenne.get(an).add(cp);
        }
        if(dsp){
          if(!distinctValues.dsp.has(dsp)) distinctValues.dsp.set(dsp,new Set());
          distinctValues.dsp.get(dsp).add(cp);
        }
        if(dep){
          if(!distinctValues.departement.has(dep)) distinctValues.departement.set(dep,new Set());
          distinctValues.departement.get(dep).add(cp);
        }
        if(t2){
          if(!distinctValues.texte2.has(t2)) distinctValues.texte2.set(t2,new Set());
          distinctValues.texte2.get(t2).add(cp);
        }
      });

      buildFilters();
      setupToggleButtons();
      map.setView([46.5,2.5],6);

      fetch('contours.geojson').then(resp=>resp.json()).then(data=>{
        if(geoLayer) geoLayer.remove();
        geoLayer=L.geoJSON(data,{
          style:function(f){
            const cp=f.properties.code_postal || f.properties.codePostal || f.properties.code || '';
            const e=extraProperties[cp];
            return {
              fillColor:(e ? e['DSP_Couleur'] || '#6688CC' : '#6688CC'),
              color:(e ? e['Ligne_Couleur'] || '#000' : '#000'),
              weight:1,
              opacity:1,
              fillOpacity:0.7
            }
          },
          onEachFeature:function(f,l){
            const cp=f.properties.code_postal || f.properties.codePostal || f.properties.code || '';
            const e=extraProperties[cp];
            if(!e) return;
            const texts=[];
            for(let i=1;i<=4;i++){
              if(e[`Texte${i}`]) texts.push(e[`Texte${i}`]);
            }
            const color=e['Police_Couleur']||'#000';
            l.bindTooltip(`<span style="color:${color}">${texts.join(' ')}</span>`);
            if(e['Clic_URL']){
              l.on('click',()=>window.open(e['Clic_URL'],'_blank'));
              l.setStyle({cursor:'pointer'});
            }
          }
        }).addTo(map);
        filterMap();
      }).catch(e=>{
        alert('Erreur chargement geojson');
        console.error(e);
        map.setView([46.5,2.5],6);
      });

      alert('Conversion et affichage réalisés !');
    };
    reader.readAsArrayBuffer(fileInput.files[0]);
  });
</script>

</body>
</html>
