<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Carte interactive codes postaux France</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
  html, body { margin:0; padding:0; height:100%; font-family: Arial, sans-serif; overflow: hidden; }
  body { display:flex; height:100vh; user-select: none; }
  #sidebar-left, #sidebar-right { background:#000; color:#fff; overflow-y: auto; padding: 10px; box-shadow: 2px 0 5px rgba(0,0,0,0.3); font-size:14px; min-width:180px; max-width:400px; resize: horizontal; }
  #sidebar-left { border-right:1px solid #444; width:250px; }
  #sidebar-right { border-left:1px solid #444; width:250px; }
  #map { flex-grow:1; height: 100vh; }
  label { display:block; margin-bottom:6px; cursor:pointer; user-select:text; color: #fff; }
  #controls { padding: 10px; background: #111; position: sticky; top: 0; z-index: 1000; border-bottom: 1px solid #444; margin-bottom: 10px; }
  .custom-tooltip { font-weight: bold; }
  .selectall-label { font-weight: bold; margin-top: 6px; border-bottom: 1px solid #444; padding-bottom: 2px; cursor: pointer; user-select: none; }
  .toggle-btn { font-size: 14px; background: #007bff; border: none; color: #fff; padding: 4px 10px; border-radius: 4px; cursor: pointer; user-select: none; margin: 10px 0 6px; width: 100%; text-align:left; }
  #toggleLeftBtn { position: fixed; top: 10px; left: 10px; z-index: 1500; padding: 8px 14px; font-size:14px; border-radius:4px; cursor: pointer; background: #ff69b4; color:#fff; box-shadow: 0 0 10px #ff69b4; user-select: none; }
  #toggleRightBtn { position: fixed; top:10px; right:10px; z-index: 1500; padding:8px 14px; font-size:14px; border-radius:4px; cursor:pointer; background:#00bfff; color:#fff; box-shadow: 0 0 10px #00bfff; user-select:none; }
  .hidden { display:none !important; }
  input[disabled] { filter: grayscale(1) brightness(1.3); }
</style>
</head>
<body>
<button id="toggleLeftBtn" title="Afficher/Masquer Réseau">Réseau</button>
<button id="toggleRightBtn" title="Afficher/Masquer Département">Département</button>

<div id="sidebar-left">
  <div id="controls">
    <input type="file" id="uploadExcel" accept=".xlsx" />
    <button id="convertBtn">Conversion et affichage</button>
  </div>

  <button class="toggle-btn" data-target="agence">Agence</button>
  <div id="filter-agence" class="hidden">
    <label class="selectall-label"><input type="checkbox" id="agence-select-all" /> Tout Agences</label>
    <div id="agenceList"></div>
  </div>

  <button class="toggle-btn" data-target="region">Région</button>
  <div id="filter-region" class="hidden">
    <label class="selectall-label"><input type="checkbox" id="region-select-all" /> Tout Régions</label>
    <div id="regionList"></div>
  </div>

  <button class="toggle-btn" data-target="antenne">Antenne</button>
  <div id="filter-antenne" class="hidden">
    <label class="selectall-label"><input type="checkbox" id="antenne-select-all" /> Tout Antennes</label>
    <div id="antenneList"></div>
  </div>

  <button class="toggle-btn" data-target="dsp">DSP</button>
  <div id="filter-dsp" class="hidden">
    <label class="selectall-label"><input type="checkbox" id="dsp-select-all" /> Tout DSP</label>
    <div id="dspList"></div>
  </div>

  <button class="toggle-btn" data-target="canaldis">Canal DIS</button>
  <div id="filter-canaldis" class="hidden">
    <label class="selectall-label"><input type="checkbox" id="canaldis-select-all" /> Tout Canal DIS</label>
    <div id="canaldisList"></div>
  </div>
</div>

<div id="sidebar-right">
  <button class="toggle-btn" data-target="departement">Département</button>
  <div id="filter-departement" class="hidden">
    <label class="selectall-label"><input type="checkbox" id="departement-select-all" /> Tout Départements</label>
    <div id="departementList"></div>
  </div>
  <button class="toggle-btn" data-target="texte2">Texte2</button>
  <div id="filter-texte2" class="hidden">
    <label class="selectall-label"><input type="checkbox" id="texte2-select-all" /> Tout Texte2</label>
    <div id="texte2List"></div>
  </div>
</div>

<div id="map"></div>

<script>
const fields = ['agence', 'region', 'antenne', 'departement', 'texte2', 'dsp', 'canaldis'];
let extraProperties = {};
let distinctValues = {};
let filterState = {};
fields.forEach(f => {
  distinctValues[f] = new Map();
  filterState[f] = new Map();
});

let map = L.map('map', { center: [46.5, 2.5], zoom: 6 });
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 18, attribution: '© OpenStreetMap contributors' }).addTo(map);

let geoLayer;

function getField(obj, key) {
  let keyNorm = key.toLowerCase().replace(/\s/g, '');
  for (let k in obj) {
    if (k.toLowerCase().replace(/\s/g, '') == keyNorm)
      return obj[k];
  }
  return "";
}

function getFilteredCPs() {
  let res = [];
  for (let cp in extraProperties) {
    let data = extraProperties[cp];
    if (!data) continue;
    let valid = fields.every(field => {
      let val = getField(data, field.charAt(0).toUpperCase() + field.slice(1));
      if (filterState[field].has(val) && filterState[field].get(val) === false) return false;
      return true;
    });
    if (valid) res.push(cp);
  }
  return res;
}

function updateFilters() {
  let validCPs = getFilteredCPs();
  let allowedValues = {};
  fields.forEach(f => allowedValues[f] = new Set());
  validCPs.forEach(cp => {
    let data = extraProperties[cp];
    fields.forEach(f => {
      let val = getField(data, f.charAt(0).toUpperCase() + f.slice(1));
      if (val) allowedValues[f].add(val);
    });
  });

  fields.forEach(field => {
    let container = document.getElementById(field + "List");
    if (!container) return;
    container.innerHTML = "";
    let allVals = Array.from(distinctValues[field].keys()).sort();

    for (let val of allVals) {
      let label = document.createElement("label");
      label.title = distinctValues[field].get(val).size + " codes postaux";
      let checkbox = document.createElement("input");
      checkbox.type = "checkbox";
      if (!filterState[field].has(val)) filterState[field].set(val, true);
      checkbox.checked = filterState[field].get(val);
      checkbox.disabled = !allowedValues[field].has(val);
      checkbox.addEventListener("change", () => {
        filterState[field].set(val, checkbox.checked);
        updateFilters();
        updateMapLayers();
      });
      label.appendChild(checkbox);
      label.appendChild(document.createTextNode(" " + val));
      container.appendChild(label);
    }
    updateSelectAll(field);
  });
}

function updateSelectAll(field) {
  let selectAll = document.getElementById(field + " -all");
  if (!selectAll) return;
  let container = document.getElementById(field + "List");
  if (!container) return;
  let checkboxes = container.querySelectorAll('input[type="checkbox"]:not([disabled])');
  if (checkboxes.length == 0) {
    selectAll.checked = false;
    selectAll.indeterminate = false;
    return;
  }
  let allChecked = Array.from(checkboxes).every(cb => cb.checked);
  let someChecked = Array.from(checkboxes).some(cb => cb.checked);
  selectAll.checked = allChecked;
  selectAll.indeterminate = !allChecked && someChecked;
}

function updateMapLayers() {
  if (!geoLayer) return;
  let validCPs = getFilteredCPs();
  geoLayer.eachLayer(layer => {
    let cp = layer.feature.properties.code_postal || layer.feature.properties.codePostal || layer.feature.properties.code || "";
    if (validCPs.includes(cp))
      layer.addTo(map);
    else
      map.removeLayer(layer);
  });
}

function initFilters() {
  fields.forEach(field => {
    let container = document.getElementById(field + "List");
    if (!container) return;
    container.innerHTML = "";
    let vals = Array.from(distinctValues[field].keys()).sort();
    for (let val of vals) {
      let label = document.createElement("label");
      label.title = distinctValues[field].get(val).size + " codes postaux";
      let checkbox = document.createElement("input");
      checkbox.type = "checkbox";
      filterState[field].set(val, true);
      checkbox.checked = true;
      checkbox.addEventListener("change", () => {
        filterState[field].set(val, checkbox.checked);
        updateFilters();
        updateMapLayers();
      });
      label.appendChild(checkbox);
      label.appendChild(document.createTextNode(" " + val));
      container.appendChild(label);
    }
    let allCheckbox = document.getElementById(field + "-all");
    if (allCheckbox) {
      allCheckbox.checked = true;
      allCheckbox.indeterminate = false;
      allCheckbox.addEventListener("change", () => {
        let checked = allCheckbox.checked;
        let cont = document.getElementById(field + "List");
        if (!cont) return;
        let checks = cont.querySelectorAll('input[type="checkbox"]:not([disabled])');
        checks.forEach(cb => {
          cb.checked = checked;
          filterState[field].set(cb.nextSibling.textContent.trim(), checked);
        });
        updateFilters();
        updateMapLayers();
      });
    }
  });
}

document.getElementById("convertBtn").addEventListener("click", () => {
  let input = document.getElementById("uploadExcel");
  let file = input.files[0];
  if (!file) {
    alert("Veuillez sélectionner un fichier Excel (.xlsx)");
    return;
  }
  let reader = new FileReader();
  reader.onload = e => {
    let data = new Uint8Array(e.target.result);
    let workbook = XLSX.read(data, { type: "array" });
    let sheetName = workbook.SheetNames[0];
    let jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);

    extraProperties = {};
    fields.forEach(f => {
      distinctValues[f].clear();
      filterState[f].clear();
    });

    jsonData.forEach(row => {
      let cp = row["Code Postal"];
      if(!cp) return;
      cp = cp.toString();
      extraProperties[cp] = row;
      fields.forEach(f => {
        let val = getField(row, f.charAt(0).toUpperCase() + f.slice(1));
        if(!distinctValues[f].has(val)) distinctValues[f].set(val, new Set());
        distinctValues[f].get(val).add(cp);
      });
    });

    for (let f of fields) {
      for (let val of distinctValues[f].keys()) {
        if (!filterState[f].has(val)) filterState[f].set(val, true);
      }
    }

    initFilters();

    updateFilters();

    updateMapLayers();

    L.marker([46.5, 2.5]).addTo(map);

    alert("Conversion et affichage réalisés");
  };
  reader.readAsArrayBuffer(file);
});

function updateMapLayers() {
  if (!geoLayer) return;
  let validCPs = getFilteredCPs();
  geoLayer.eachLayer(layer => {
    let cp = layer.feature.properties.code_postal || layer.feature.properties.codePostal || layer.feature.properties.code || "";
    if (validCPs.includes(cp))
      layer.addTo(map);
    else
      map.removeLayer(layer);
  });
}

const tileLayerURL = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
const tileLayerOpts = { maxZoom: 18, attribution: '© OpenStreetMap contributors' };
L.tileLayer(tileLayerURL, tileLayerOpts).addTo(map);

fetch('contours.geojson').then(res => {
  if (!res.ok) throw new Error("Erreur de chargement GeoJSON");
  return res.json();
}).then(data => {
  geoLayer = L.geoJSON(data, {
    style: function(feature) {
      let cp = feature.properties.code_postal || feature.properties.codePostal || feature.properties.code || "";
      let ex = extraProperties[cp] || {};
      return {
        fillColor: getField(ex, "Fond_couleur") || "#66cc66",
        color: getField(ex, "Ligne_couleur") || "#000",
        weight: 1, opacity: 1, fillOpacity: 0.7
      };
    },
    onEachFeature: function(feature, layer) {
      let cp = feature.properties.code_postal || feature.properties.codePostal || feature.properties.code || "";
      let ex = extraProperties[cp] || {};
      let texts = ["Texte1", "Texte2", "Texte3", "Texte4"].map(f => getField(ex, f)).filter(Boolean);
      let tooltip = texts.join(" ");
      let c = getField(ex, "police couleur") || "#000";
      layer.bindTooltip(`<span style="color:${c}">${tooltip || ("Code Postal : " + cp)}</span>`);
      let u = getField(ex, "Clic URL");
      if (u && u.trim().length > 0) {
        layer.on("click", () => window.open(u, '_blank'));
        layer.setStyle({ cursor: "pointer" });
      }
    }
  }).addTo(map);
});

document.getElementById('toggleLeftBtn').addEventListener('click', ()=>{
  let s = document.getElementById('sidebar-left');
  s.style.display = s.style.display === 'none' ? 'block' : 'none';
});
document.getElementById('toggleRightBtn').addEventListener('click', ()=>{
  let s = document.getElementById('sidebar-right');
  s.style.display = s.style.display === 'none' ? 'block' : 'none';
});
</script>
</body>
</html>
