<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Carte interactive codes postaux France</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
  html, body { margin:0; padding:0; height:100%; font-family: Arial, sans-serif; }
  body { display: flex; height: 100vh; user-select: none; margin: 0; }
  #sidebar-left, #sidebar-right {
    background: #000;
    color: #fff;
    overflow-y: auto;
    padding: 10px;
    box-shadow: 2px 0 5px rgba(0,0,0,0.3);
    font-size: 14px;
    min-width: 220px;
    max-width: 400px;
    resize: horizontal;
  }
  #sidebar-left { border-right: 1px solid #444; }
  #sidebar-right { border-left: 1px solid #444; }
  #map { flex-grow: 1; height: 100vh; }
  label { display: block; cursor: pointer; margin-bottom: 4px; }
  label span { margin-left: 4px; }
  .selectAllLabel {
    font-weight: bold;
    cursor: pointer;
    margin: 6px 0 4px;
    user-select: none;
  }
  .toggleBtn {
    background: #2C3E50;
    padding: 8px 12px;
    width: 100%;
    color: white;
    border: none;
    text-align: left;
    margin-top: 8px;
    cursor: pointer;
    font-weight: bold;
  }
  .toggleBtn.active {
    background: #3C5A78;
  }
  #toggleLeftBtn {
    position: fixed;
    top: 10px;
    left: 10px;
    background-color: #FF69B4;
    color: black;
    padding: 8px 14px;
    border-radius: 5px;
    z-index: 1500;
    cursor: pointer;
    box-shadow: 0 0 10px #FF69B4;
    user-select: none;
  }
  #toggleRightBtn {
    position: fixed;
    top: 10px;
    right: 10px;
    background-color: #007bff;
    color: white;
    padding: 8px 14px;
    border-radius: 5px;
    z-index: 1500;
    cursor: pointer;
    box-shadow: 0 0 10px #007bff;
    user-select: none;
  }
  .hidden {
    display: none !important;
  }
  input[disabled] {
    filter: grayscale(1) brightness(1.4);
  }
</style>
</head>
<body>
<button id="toggleLeftBtn" title="Afficher/Masquer Réseau">Réseau</button>
<button id="toggleRightBtn" title="Afficher/Masquer Département">Département</button>

<div id="sidebar-left">
  <div id="controls">
    <input type="file" id="uploadExcel" accept=".xlsx" />
    <button id="convertBtn">Conversion et affichage</button>
  </div>
  <button class="toggleBtn" data-target="agence">Agence</button>
  <div id="filter-agence" class="hidden">
    <label class="selectAllLabel"><input type="checkbox" id="agence_all"> Tout Agences</label>
    <div id="agenceList"></div>
  </div>

  <button class="toggleBtn" data-target="region">Région</button>
  <div id="filter-region" class="hidden">
    <label class="selectAllLabel"><input type="checkbox" id="region_all"> Tout Régions</label>
    <div id="regionList"></div>
  </div>

  <button class="toggleBtn" data-target="antenne">Antenne</button>
  <div id="filter-antenne" class="hidden">
    <label class="selectAllLabel"><input type="checkbox" id="antenne_all"> Tout Antennes</label>
    <div id="antenneList"></div>
  </div>

  <button class="toggleBtn" data-target="dsp">DSP</button>
  <div id="filter-dsp" class="hidden">
    <label class="selectAllLabel"><input type="checkbox" id="dsp_all"> Tout DSP</label>
    <div id="dspList"></div>
  </div>

  <button class="toggleBtn" data-target="canaldis">Canal DIS</button>
  <div id="filter-canaldis" class="hidden">
    <label class="selectAllLabel"><input type="checkbox" id="canaldis_all"> Tout Canal DIS</label>
    <div id="canaldisList"></div>
  </div>
</div>

<div id="sidebar-right">
  <button class="toggleBtn" data-target="departement">Département</button>
  <div id="filter-departement" class="hidden">
    <label class="selectAllLabel"><input type="checkbox" id="departement_all"> Tout Départements</label>
    <div id="departementList"></div>
  </div>

  <button class="toggleBtn" data-target="texte2">Texte 2</button>
  <div id="filter-texte2" class="hidden">
    <label class="selectAllLabel"><input type="checkbox" id="texte2_all"> Tout Texte 2</label>
    <div id="texte2List"></div>
  </div>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
  const map = L.map('map').setView([46.5,2.5],6);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    maxZoom:18,
    attribution:'© OpenStreetMap contributors'
  }).addTo(map);

  const fields = ['agence', 'region', 'antenne', 'departement', 'texte2', 'dsp', 'canaldis'];
  let distinctValues = {}, filterState = {}, extraProperties = {};
  fields.forEach(f=>{
    distinctValues[f] = new Map();
    filterState[f] = new Map();
  });

  let geoLayer;

  function normalizeKey(s){return s.toLowerCase().replace(/\s+/g,'');}

  function getField(obj, key){
    const k = normalizeKey(key);
    for(const prop in obj)
      if(normalizeKey(prop)==k) return obj[prop] || "";
    return "";
  }

  function computeValidCP(){
    return Object.keys(extraProperties).filter(cp=>{
      const row = extraProperties[cp];
      return fields.every(f=>{
        const val = getField(row, f.charAt(0).toUpperCase()+f.slice(1));
        return !filterState[f].has(val) || filterState[f].get(val);
      });
    });
  }

  function updateFilterLists(){
    const validCP = computeValidCP();

    // For each field, compute possible values for current filter context
    const availableValues = {};
    fields.forEach(f=>availableValues[f] = new Set());
    validCP.forEach(cp=>{
      const row=extraProperties[cp];
      fields.forEach(f=>{
        const val = getField(row,f.charAt(0).toUpperCase()+f.slice(1));
        if(val) availableValues[f].add(val);
      });
    });

    fields.forEach(f=>{
      const container = document.getElementById(f+"List");
      if(!container) return;
      container.innerHTML = '';
      Array.from(distinctValues[f].keys()).sort().forEach(val=>{
        if(!val) return; // skip empty strings
        const label = document.createElement('label');
        label.title = distinctValues[f].get(val).size + " codes postaux";

        const cb = document.createElement('input');
        cb.type = 'checkbox';

        if(!filterState[f].has(val))
          filterState[f].set(val,true);
        cb.checked = filterState[f].get(val);

        cb.disabled = !availableValues[f].has(val);

        cb.addEventListener('change',()=>{
          filterState[f].set(val, cb.checked);
          updateFilterLists();
          updateMapVisibility();
        });

        label.appendChild(cb);
        label.appendChild(document.createTextNode(" " + val));
        container.appendChild(label);
      });
      updateSelectAll(f);
    });
  }

  function updateSelectAll(field){
    const allCheckbox = document.getElementById(field+'_all');
    if(!allCheckbox) return;

    const container = document.getElementById(field+'List');
    if(!container){
      allCheckbox.checked=false; allCheckbox.indeterminate=false; return;
    }

    let boxes = Array.from(container.querySelectorAll('input[type=checkbox]:not(:disabled)'));
    if(boxes.length==0){
      allCheckbox.checked=false; allCheckbox.indeterminate=false; return;
    }
    let allChecked = boxes.every(box => box.checked);
    let anyChecked = boxes.some(box => box.checked);

    allCheckbox.checked = allChecked;
    allCheckbox.indeterminate = !allChecked && anyChecked;
  }

  function setupAllCheckboxes(){
    fields.forEach(f=>{
      const allCheckbox = document.getElementById(f+"_all");
      if(!allCheckbox) return;
      allCheckbox.addEventListener('change',()=>{
        const container = document.getElementById(f+"List");
        if(!container) return;

        const val = allCheckbox.checked;
        Array.from(container.querySelectorAll('input[type=checkbox]:not(:disabled)')).forEach(cb=>{
          cb.checked = val;
          filterState[f].set(cb.nextSibling.textContent.trim(), val);
        });
        updateFilterLists();
        updateMapVisibility();
      });
    });
  }

  function updateMapVisibility(){
    if(!geoLayer) return;
    const validCP = computeValidCP();
    geoLayer.eachLayer(layer=>{
      const cp = layer.feature.properties.code_postal || layer.feature.properties.codePostal || layer.feature.properties.code || "";
      if(validCP.includes(cp)){
        layer.addTo(map);
      }else{
        map.removeLayer(layer);
      }
    });
  }

  function buildFilters(){
    fields.forEach(f=>{
      const container = document.getElementById(f+"List");
      if(!container) return;
      container.innerHTML = '';
      Array.from(distinctValues[f].keys()).sort().forEach(val=>{
        if(!val) return;
        const label = document.createElement('label');
        label.title = distinctValues[f].get(val).size + " codes postaux";

        const cb = document.createElement('input');
        cb.type = 'checkbox';
        if(!filterState[f].has(val))
          filterState[f].set(val,true);
        cb.checked = filterState[f].get(val);

        cb.addEventListener('change',()=>{
          filterState[f].set(val,cb.checked);
          updateFilterLists();
          updateMapVisibility();
        });

        label.appendChild(cb);
        label.appendChild(document.createTextNode(" "+val));
        container.appendChild(label);
      });
      updateSelectAll(f);
    });
    setupAllCheckboxes();
    setupToggleButtons();
  }

  function setupToggleButtons(){
    document.querySelectorAll('.toggleBtn').forEach(btn=>{
      const target = btn.getAttribute('data-target');
      btn.textContent = target.charAt(0).toUpperCase()+target.slice(1);
      btn.addEventListener('click',()=>{
        const el = document.getElementById('filter-'+target);
        if(!el) return;
        if(el.classList.contains('hidden')){
          el.classList.remove('hidden');
          btn.textContent = 'Masquer '+target.charAt(0).toUpperCase()+target.slice(1);
        }else{
          el.classList.add('hidden');
          btn.textContent = target.charAt(0).toUpperCase()+target.slice(1);
        }
      });
    });
  }

  document.getElementById('toggleLeftBtn').addEventListener('click', ()=>{
    const el = document.getElementById('sidebar-left');
    el.style.display = (el.style.display==='none') ? 'block' : 'none';
  });
  document.getElementById('toggleRightBtn').addEventListener('click', ()=>{
    const el = document.getElementById('sidebar-right');
    el.style.display = (el.style.display==='none') ? 'block' : 'none';
  });

  document.getElementById('convertBtn').addEventListener('click', ()=>{
    const input = document.getElementById('uploadExcel');
    const file = input.files[0];
    if(!file){
      alert('Veuillez sélectionner un fichier Excel.');
      return;
    }

    const reader = new FileReader();
    reader.onload = e => {
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data,{type:'array'});
      const sheetName = workbook.SheetNames[0];
      const json = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);

      extraProperties = {};
      fields.forEach(f => {
        distinctValues[f].clear();
        filterState[f].clear();
      });

      json.forEach(row => {
        const cp = row['Code Postal'] ? row['Code Postal'].toString() : "";
        if(!cp) return;
        extraProperties[cp] = row;

        fields.forEach(f => {
          const val = row[f.charAt(0).toUpperCase() + f.slice(1)] || "";
          if(!distinctValues[f].has(val))
            distinctValues[f].set(val, new Set());
          distinctValues[f].get(val).add(cp);
        });
      });

      fields.forEach(f=>{
        distinctValues[f].forEach((_,val)=>{
          if(!filterState[f].has(val))
            filterState[f].set(val,true);
        });
      });

      buildFilters();
      updateFilterLists();
      updateMapVisibility();

      map.setView([46.5,2.5],6);

      setTimeout(()=>{
        alert('Conversion et affichage réalisés');
      }, 200);
    };
    reader.readAsArrayBuffer(file);
  });
</script>

</body>
</html>
