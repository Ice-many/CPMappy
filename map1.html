<!DOCTYPE html>
<html>
<head>
  <title>Carte interactive codes postaux France</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    html, body {
      margin: 0; padding: 0; height: 100%;
      font-family: Arial, sans-serif;
      overflow: hidden;
    }
    body {
      margin: 0; padding: 0; height: 100vh;
      user-select: none;
      position: relative;
      overflow: hidden;
    }
    #sidebar-left, #sidebar-right {
      position: fixed;
      top: 40px; bottom: 0;
      background: #000; /* noir */
      color: white;
      overflow-y: auto;
      padding: 10px;
      box-shadow: 0 0 8px rgba(0,0,0,0.5);
      font-size: 14px;
      resize: none;
      user-select: text;
      -webkit-user-select: text;
    }
    #sidebar-left {
      left: 0;
      width: 280px;
      border-right: 1px solid #444;
      display: block;
    }
    #sidebar-right {
      right: 0;
      width: 280px;
      border-left: 1px solid #444;
      display: block;
    }
    #map {
      position: absolute;
      top: 40px; bottom: 0;
      left: 280px; right: 280px;
      z-index: 100;
    }
    label {
      display: block;
      margin-bottom: 6px;
      cursor: pointer;
      color: white;
    }
    #control-panel {
      position: sticky;
      top: 0;
      background: #111;
      padding: 10px;
      margin-bottom: 10px;
      border-bottom: 1px solid #444;
      z-index: 1200;
    }
    .selectall-label {
      display: flex;
      align-items: center;
      margin: 4px 0 10px;
      font-weight: bold;
      user-select: none;
    }
    .selectall-label input {
      margin-right: 8px;
    }
    .toggle-btn {
      width: 100%;
      background: #007bff;
      border: none;
      border-radius: 5px;
      color: white;
      padding: 6px 10px;
      font-size: 14px;
      cursor: pointer;
      margin: 10px 0 6px 0;
      text-align: left;
      user-select: none;
    }
    #toggleButtons {
      position: fixed;
      top: 0; left: 0; right: 0;
      padding: 5px 10px;
      background: #222;
      display: flex;
      justify-content: flex-start;
      gap: 12px;
      z-index: 1500;
      box-shadow: 0 2px 6px rgba(0,0,0,0.6);
    }
    #toggleButtons button {
      background-color: #6a0dad; /* violet */
      color: white;
      border: none;
      padding: 6px 14px;
      font-weight: bold;
      font-size: 14px;
      border-radius: 5px;
      cursor: pointer;
      box-shadow: 0 0 6px rgba(106, 13, 173, 0.9);
      user-select: none;
      transition: background-color 0.3s ease;
    }
    #toggleButtons button.active {
      background-color: #00bfff;
      box-shadow: 0 0 6px rgba(0, 191, 255, 0.85);
    }
    .hidden {
      display: none !important;
    }
  </style>
</head>
<body>

  <div id="toggleButtons">
    <button id="toggleLeftBtn" title="Afficher / Masquer Réseau" class="active">Réseau</button>
    <button id="toggleRightBtn" title="Afficher / Masquer Département" class="active">Département</button>
  </div>

  <div id="sidebar-left">
    <div id="control-panel">
      <input type="file" id="uploadExcel" accept=".xlsx" />
      <button id="convertBtn">Chargement & Affichage</button>
    </div>

    <button class="toggle-btn" data-target="agence">Agence</button>
    <div id="filter-agence" class="hidden"></div>

    <button class="toggle-btn" data-target="region">Région</button>
    <div id="filter-region" class="hidden"></div>

    <button class="toggle-btn" data-target="antenne">Antenne</button>
    <div id="filter-antenne" class="hidden"></div>

    <button class="toggle-btn" data-target="dsp">DSP</button>
    <div id="filter-dsp" class="hidden"></div>
  </div>

  <div id="sidebar-right">
    <button class="toggle-btn" data-target="departement">Département</button>
    <div id="filter-departement" class="hidden"></div>

    <button class="toggle-btn" data-target="texte2">Texte2</button>
    <div id="filter-texte2" class="hidden"></div>
  </div>

  <div id="map"></div>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
  const map = L.map('map').setView([46.5, 2.5], 6);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18,
      attribution: '© OpenStreetMap contributors'
  }).addTo(map);

  let geojsonLayer = null;
  let extraProperties = {};

  const distinctFields = ["agence", "region", "antenne", "dsp", "departement", "texte2"];
  const distinctValues = {};
  const filterState = {};

  distinctFields.forEach(field => {
    distinctValues[field] = new Map();
    filterState[field] = new Map();
  });

  // Helper to get key ignoring case and spaces
  function getFieldValue(obj, key) {
    if (!obj) return "";
    key = key.toLowerCase().replace(/\s+/g, '');
    for (let k in obj) {
      if (k.toLowerCase().replace(/\s+/g, '') === key) return obj[k];
    }
    return "";
  }

  function buildFilterList(field) {
    const container = document.getElementById(`filter-${field}`);
    if (!container) return;
    container.innerHTML = "";

    // Add the 'select all' checkbox
    let selectAll = document.createElement('label');
    selectAll.className = 'selectall-label';
    let selectAllCheckbox = document.createElement('input');
    selectAllCheckbox.type = 'checkbox';
    selectAllCheckbox.id = `${field}-select-all`;
    selectAllCheckbox.checked = true;

    selectAll.appendChild(selectAllCheckbox);
    selectAll.appendChild(document.createTextNode(` Tout`));
    container.appendChild(selectAll);

    selectAllCheckbox.addEventListener('change', () => {
      const checked = selectAllCheckbox.checked;
      for (let key of distinctValues[field].keys()) {
        filterState[field].set(key, checked);
      }
      updateFilterCheckboxes(field, checked);
      filterMap();
    });

    // Add checkboxes for each distinct value
    let values = Array.from(distinctValues[field].keys()).sort((a, b) => a.localeCompare(b));
    values.forEach(value => {
      let label = document.createElement('label');
      label.title = `Nombre de codes postaux: ${distinctValues[field].get(value).size}`;
      let checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.checked = true;

      filterState[field].set(value, true);

      checkbox.addEventListener('change', () => {
        filterState[field].set(value, checkbox.checked);
        updateSelectAllState(field);
        filterMap();
      });

      label.appendChild(checkbox);
      label.appendChild(document.createTextNode(` ${value}`));
      container.appendChild(label);
    });
  }

  function updateFilterCheckboxes(field, checked) {
    let container = document.getElementById(`filter-${field}`);
    if (!container) return;
    const checkboxes = container.querySelectorAll('input[type=checkbox]');
    checkboxes.forEach(cb => cb.checked = checked);
    updateSelectAllState(field);
  }

  function updateSelectAllState(field) {
    let selectAllCheckbox = document.getElementById(`${field}-select-all`);
    if (!selectAllCheckbox) return;
    let values = Array.from(filterState[field].values());
    let allChecked = values.every(v => v === true);
    let noneChecked = values.every(v => v === false);
    selectAllCheckbox.checked = allChecked;
    selectAllCheckbox.indeterminate = !allChecked && !noneChecked;
  }

  function setupFilterToggles() {
    document.querySelectorAll('.toggle-btn').forEach(btn => {
      let target = btn.getAttribute('data-target');
      btn.textContent = target.charAt(0).toUpperCase() + target.slice(1);
      btn.addEventListener('click', () => {
        let panel = document.getElementById(`filter-${target}`);
        if (!panel) return;
        if (panel.classList.contains('hidden')) {
          panel.classList.remove('hidden');
          btn.textContent = `Masquer ${target.charAt(0).toUpperCase() + target.slice(1)}`;
        } else {
          panel.classList.add('hidden');
          btn.textContent = target.charAt(0).toUpperCase() + target.slice(1);
        }
      });
    });
  }

  document.getElementById('convertBtn').addEventListener('click', () => {
    const input = document.getElementById('uploadExcel');
    if (input.files.length === 0) {
      alert("Veuillez sélectionner un fichier Excel.");
      return;
    }

    let reader = new FileReader();
    reader.onload = (e) => {
      let data = new Uint8Array(e.target.result);
      let workbook = XLSX.read(data, { type: "array" });
      let firstSheet = workbook.SheetNames[0];
      let jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[firstSheet]);

      extraProperties = {};
      distinctFields.forEach(field => {
        distinctValues[field] = new Map();
        filterState[field] = new Map();
      });

      jsonData.forEach(row => {
        let cp = row['Code Postal'];
        if (!cp) return;
        cp = cp.toString();
        extraProperties[cp] = row;

        distinctFields.forEach(field => {
          let val = getFieldValue(row, field);
          if (val) {
            if (!distinctValues[field].has(val)) distinctValues[field].set(val, new Set());
            distinctValues[field].get(val).add(cp);
          }
        });
      });

      distinctFields.forEach(field => {
        buildFilterList(field);
        updateSelectAllState(field);
      });

      setupFilterToggles();

      map.setView([46.5, 2.5], 6);

      fetch("contours.geojson")
        .then(res => {
          if (!res.ok) throw new Error("Impossible de charger le fichier GeoJSON.");
          return res.json();
        })
        .then(geojson => {
          if (geojsonLayer) geojsonLayer.remove();

          geojsonLayer = L.geoJSON(geojson, {
            style: (feature) => {
              let cp = feature.properties.code_postal || feature.properties.codePostal || feature.properties.code || "";
              let props = extraProperties[cp] || {};
              return {
                fillColor: props["DSP_Couleur"] || "#6688CC",
                color: props["Ligne_Couleur"] || "#000000",
                weight: 1,
                opacity: 1,
                fillOpacity: 0.7,
              };
            },
            onEachFeature: (feature, layer) => {
              let cp = feature.properties.code_postal || feature.properties.codePostal || feature.properties.code || "";
              let props = extraProperties[cp] || {};
              let textArr = [];
              for(let i=1; i<=4; i++){
                if(props[`Texte${i}`]) textArr.push(props[`Texte${i}`]);
              }
              let color = props["police couleur"] || "#000000";
              layer.bindTooltip(`<span style="color:${color}">${textArr.join(" ")}</span>`);
              if(props["Clic URL"]){
                layer.on("click", () => window.open(props["Clic URL"], "_blank"));
                layer.setStyle({cursor: "pointer"});
              }
            }
          }).addTo(map);

          filterMap();

        }).catch(err => {
          alert(err.message);
          map.setView([46.5,2.5], 6);
        });

      alert("Conversion et affichage réalisés !");
    };

    reader.readAsArrayBuffer(input.files[0]);
  });

  function filterMap() {
    if (!geojsonLayer) return;
    geojsonLayer.eachLayer(layer => {
      let cp = layer.feature.properties.code_postal || layer.feature.properties.codePostal || layer.feature.properties.code || "";
      let props = extraProperties[cp];
      if (!props) {
        if (layer._map) layer.remove();
        return;
      }

      let vals = {};
      ["agence", "region", "antenne", "dsp", "departement", "texte2"].forEach(field => {
        vals[field] = getFieldValue(props, field);
      });

      let visible = true;
      for(let field in vals){
        if(filterState[field] && filterState[field].get(vals[field]) === false){
          visible = false;
          break;
        }
      }

      if (visible) {
        if (!layer._map) layer.addTo(map);
      } else {
        if (layer._map) layer.remove();
      }
    });
  }
</script>
</body>
</html>
