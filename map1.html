<!DOCTYPE html>
<html>
<head>
  <title>Carte interactive codes postaux France</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    html, body {
      margin: 0; padding: 0; height: 100%;
      font-family: Arial, sans-serif;
      overflow: hidden;
    }
    body {
      display: flex;
      height: 100vh;
      user-select: none;
    }
    #sidebar-left, #sidebar-right {
      background: #000;
      color: white;
      overflow-y: auto;
      padding: 10px;
      box-shadow: 2px 0 5px rgba(0,0,0,0.3);
      font-size: 14px;
      min-width: 180px;
      max-width: 400px;
      resize: horizontal;
      overflow: auto;
    }
    #sidebar-left {
      border-right: 1px solid #444;
      width: 250px;
    }
    #sidebar-right {
      border-left: 1px solid #444;
      width: 250px;
    }
    #map {
      flex-grow: 1;
      height: 100vh;
    }
    label {
      display: block;
      margin-bottom: 6px;
      cursor: pointer;
      user-select: text;
      color: white;
    }
    #controls {
      padding: 10px;
      background: #111;
      position: sticky;
      top: 0;
      z-index: 1000;
      border-bottom: 1px solid #444;
      margin-bottom: 10px;
      user-select: none;
      color: white;
    }
    .custom-tooltip {
      font-weight: bold;
    }
    .selectall-label {
      font-weight: bold;
      margin-top: 6px;
      border-bottom: 1px solid #444;
      padding-bottom: 2px;
      cursor: pointer;
      user-select: none;
      color: white;
    }
    .toggle-btn {
      font-size: 14px;
      background: #007bff;
      border: none;
      color: white;
      padding: 4px 10px;
      border-radius: 4px;
      cursor: pointer;
      user-select: none;
      margin: 10px 0 6px 0;
      width: 100%;
      text-align: left;
    }
    #toggleLeftBtn, #toggleRightBtn {
      position: fixed;
      top: 10px;
      padding: 8px 14px;
      font-size: 14px;
      border-radius: 4px;
      cursor: pointer;
      z-index: 1300;
      user-select: none;
      box-shadow: 0 2px 8px rgba(0,191,255,0.7);
      color: white;
      background-color: #00bfff;
      transition: background-color 0.3s ease;
    }
    #toggleLeftBtn.violet, #toggleRightBtn.violet {
      background-color: #6a0dad !important;
      box-shadow: 0 2px 8px rgba(106,13,173,0.7) !important;
    }
    #toggleLeftBtn { left: 10px; }
    #toggleRightBtn { right: 10px; }

    .hidden { display: none !important; }
  </style>
</head>
<body>

  <button id="toggleLeftBtn" title="Afficher/Masquer Réseau">Réseau</button>
  <button id="toggleRightBtn" title="Afficher/Masquer Département">Département</button>

  <div id="sidebar-left">
    <div id="controls">
      <input type="file" id="uploadExcel" accept=".xlsx" />
      <button id="convertBtn">Conversion JSON et Affichage</button>
    </div>

    <button class="toggle-btn" data-target="agence">Agence</button>
    <div id="filter-agence" class="hidden">
      <label class="selectall-label"><input type="checkbox" id="agence-select-all" checked> Tout Agences</label>
      <div id="agenceList"></div>
    </div>

    <button class="toggle-btn" data-target="region">Région</button>
    <div id="filter-region" class="hidden">
      <label class="selectall-label"><input type="checkbox" id="region-select-all" checked> Tout Régions</label>
      <div id="regionList"></div>
    </div>

    <button class="toggle-btn" data-target="antenne">Antenne</button>
    <div id="filter-antenne" class="hidden">
      <label class="selectall-label"><input type="checkbox" id="antenne-select-all" checked> Tout Antennes</label>
      <div id="antenneList"></div>
    </div>
  </div>

  <div id="map"></div>

  <div id="sidebar-right">
    <button class="toggle-btn" data-target="departement">Département</button>
    <div id="filter-departement" class="hidden">
      <label class="selectall-label"><input type="checkbox" id="departement-select-all" checked> Tout Départements</label>
      <div id="departementList"></div>
    </div>

    <button class="toggle-btn" data-target="texte2">Texte2</button>
    <div id="filter-texte2" class="hidden">
      <label class="selectall-label"><input type="checkbox" id="texte2-select-all" checked> Tout Texte2</label>
      <div id="texte2List"></div>
    </div>
  </div>

<script>
  var map = L.map('map', { minZoom: 6, center: [46.6, 2.4], zoom: 6 });

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 18,
    attribution: '© OpenStreetMap contributors'
  }).addTo(map);

  let extraProperties = {};
  let geoLayer;

  let distinctValues = {
    agence: new Map(),
    region: new Map(),
    antenne: new Map(),
    departement: new Map(),
    texte2: new Map()
  };

  let filterState = {
    agence: new Map(),
    region: new Map(),
    antenne: new Map(),
    departement: new Map(),
    texte2: new Map()
  };

  function getKeyIgnoreCase(obj, key) {
    key = key.toLowerCase().replace(/\s+/g, '');
    for (const k in obj) {
      if (k.toLowerCase().replace(/\s+/g, '') === key) return obj[k];
    }
    return null;
  }

  function buildFilterList(filterName, containerId) {
    const container = document.getElementById(containerId);
    container.innerHTML = '';
    const mapVals = distinctValues[filterName];
    const sortedVals = Array.from(mapVals.keys()).sort((a,b) => a.localeCompare(b, undefined, {ignorePunctuation: true}));
    sortedVals.forEach(val => {
      const cpSet = mapVals.get(val);
      const label = document.createElement('label');
      label.title = `${cpSet.size} codes postaux`;

      const checkbox = document.createElement('input');
      checkbox.type = 'checkbox';
      checkbox.checked = true;
      filterState[filterName].set(val, true);

      checkbox.addEventListener('change', () => {
        filterState[filterName].set(val, checkbox.checked);
        filterGeoLayer();
        updateSelectAllCheckbox(filterName);
      });

      label.appendChild(checkbox);
      label.appendChild(document.createTextNode(' ' + val));
      container.appendChild(label);
    });
  }

  function updateSelectAllCheckbox(filterName) {
    const selectAllCheckbox = document.getElementById(filterName + '-select-all');
    if(!selectAllCheckbox) return;
    const values = Array.from(filterState[filterName].values());
    selectAllCheckbox.checked = values.every(v => v === true);
    selectAllCheckbox.indeterminate = values.some(v => v === true) && !selectAllCheckbox.checked;
  }

  function setupSelectAllListener(filterName) {
    const selectAllCheckbox = document.getElementById(filterName + '-select-all');
    if(!selectAllCheckbox) return;
    selectAllCheckbox.addEventListener('change', () => {
      const checked = selectAllCheckbox.checked;
      filterState[filterName].forEach((_, key) => filterState[filterName].set(key, checked));

      const container = document.getElementById(filterName + 'List');
      Array.from(container.querySelectorAll('input[type="checkbox"]')).forEach(cb => {
        cb.checked = checked;
      });

      filterGeoLayer();
    });
  }

  function setupFilterToggleButtons() {
    const buttons = document.querySelectorAll('.toggle-btn');
    buttons.forEach(btn => {
      const targetId = btn.getAttribute('data-target');
      btn.textContent = capitalizeFirstLetter(targetId);
      btn.addEventListener('click', () => {
        const el = document.getElementById('filter-' + targetId);
        if (!el) return;
        if (el.classList.contains('hidden')) {
          el.classList.remove('hidden');
          btn.textContent = 'Masquer ' + capitalizeFirstLetter(targetId);
        } else {
          el.classList.add('hidden');
          btn.textContent = capitalizeFirstLetter(targetId);
        }
      });
    });
  }

  function capitalizeFirstLetter(str) {
    return str.charAt(0).toUpperCase() + str.slice(1);
  }

  document.getElementById('toggleLeftBtn').addEventListener('click', () => {
    const left = document.getElementById('sidebar-left');
    left.style.display = (left.style.display === 'none') ? 'block' : 'none';
  });

  document.getElementById('toggleRightBtn').addEventListener('click', () => {
    const right = document.getElementById('sidebar-right');
    right.style.display = (right.style.display === 'none') ? 'block' : 'none';
  });

  function filterGeoLayer() {
    if (!geoLayer) return;
    geoLayer.eachLayer(layer => {
      let cp = layer.feature.properties.code_postal || layer.feature.properties.codePostal || layer.feature.properties.code || "";
      let extras = extraProperties[cp] || {};

      let valAgence = getKeyIgnoreCase(extras, "Agence") || "";
      let valRegion = getKeyIgnoreCase(extras, "région") || "";
      let valAntenne = getKeyIgnoreCase(extras, "Antenne") || "";
      let valDepartement = getKeyIgnoreCase(extras, "Departement") || "";
      let valTexte2 = getKeyIgnoreCase(extras, "Texte2") || "";

      let show = true;

      show = show && filterState.agence.get(valAgence) !== false;
      show = show && filterState.region.get(valRegion) !== false;
      show = show && filterState.antenne.get(valAntenne) !== false;
      show = show && filterState.departement.get(valDepartement) !== false;
      show = show && filterState.texte2.get(valTexte2) !== false;

      if (show) {
        layer.addTo(map);
      } else {
        map.removeLayer(layer);
      }
    });
  }

  function updateDistinctValues(jsonData) {
    for (const key in distinctValues) {
      distinctValues[key].clear();
      filterState[key].clear();
    }

    jsonData.forEach(item => {
      const cp = (item["Code Postal"] || "").toString();
      if (!cp) return;

      const ag = getKeyIgnoreCase(item, "Agence") || "";
      const re = getKeyIgnoreCase(item, "région") || "";
      const an = getKeyIgnoreCase(item, "Antenne") || "";
      const dep = getKeyIgnoreCase(item, "Departement") || "";
      const tx2 = getKeyIgnoreCase(item, "Texte2") || "";

      if (!distinctValues.agence.has(ag)) distinctValues.agence.set(ag, new Set());
      distinctValues.agence.get(ag).add(cp);

      if (!distinctValues.region.has(re)) distinctValues.region.set(re, new Set());
      distinctValues.region.get(re).add(cp);

      if (!distinctValues.antenne.has(an)) distinctValues.antenne.set(an, new Set());
      distinctValues.antenne.get(an).add(cp);

      if (!distinctValues.departement.has(dep)) distinctValues.departement.set(dep, new Set());
      distinctValues.departement.get(dep).add(cp);

      if (!distinctValues.texte2.has(tx2)) distinctValues.texte2.set(tx2, new Set());
      distinctValues.texte2.get(tx2).add(cp);
    });
  }

  function buildFilterLists() {
    ['agence', 'region', 'antenne', 'departement', 'texte2'].forEach(filter => {
      buildFilterList(filter, filter + 'List');
    });

    ['agence', 'region', 'antenne', 'departement', 'texte2'].forEach(filt => {
      updateSelectAllCheckbox(filt);
      setupSelectAllListener(filt);
    });
  }

  document.getElementById('convertBtn').onclick = () => {
    const fileInput = document.getElementById('uploadExcel');
    const file = fileInput.files[0];
    if (!file) {
      alert("Sélectionnez un fichier Excel (.xlsx) à convertir avant de cliquer.");
      return;
    }
    const reader = new FileReader();
    reader.onload = e => {
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, {type: 'array'});
      const firstSheetName = workbook.SheetNames[0];
      const sheet = workbook.Sheets[firstSheetName];
      const jsonData = XLSX.utils.sheet_to_json(sheet);

      extraProperties = {};
      updateDistinctValues(jsonData);

      jsonData.forEach(item => {
        const cp = (item["Code Postal"] || "").toString();
        if (cp.length > 0) extraProperties[cp] = item;
      });

      buildFilterLists();

      setupFilterToggleButtons();

      map.setView([46.6, 2.4], 6);

      updateMapWithExtraProperties();
      alert("Conversion et affichage réalisés !");
    };
    reader.readAsArrayBuffer(file);
  };

  function updateMapWithExtraProperties() {
    fetch('contours-codes-postaux.geojson')
      .then(res => {
        if (!res.ok) throw new Error("Le fichier GeoJSON n'a pas été chargé correctement.");
        return res.json();
      })
      .then(data => {
        if (geoLayer) map.removeLayer(geoLayer);
        geoLayer = L.geoJSON(data, {
          style: function(feature) {
            let cp = feature.properties.code_postal || feature.properties.codePostal || feature.properties.code || "";
            let extras = extraProperties[cp] || {};
            return {
              fillColor: getKeyIgnoreCase(extras, "Fond_couleur") || "#66cc66",
              color: getKeyIgnoreCase(extras, "Ligne_couleur") || "#000000",
              weight: 1,
              opacity: 1,
              fillOpacity: 0.7
            };
          },
          onEachFeature: function(feature, layer) {
            let cp = feature.properties.code_postal || feature.properties.codePostal || feature.properties.code || "";
            let extras = extraProperties[cp] || {};
            let texteParts = [];
            ["Texte1", "Texte2", "Texte3", "Texte4"].forEach(field => {
              let val = getKeyIgnoreCase(extras, field);
              if (val) texteParts.push(val);
            });
            let tooltipText = texteParts.join(" ");
            let policeCouleur = getKeyIgnoreCase(extras, "police couleur") || '#000000';
            layer.bindTooltip(
              `<span style="color: ${policeCouleur};">${tooltipText || ("Code Postal : " + cp)}</span>`,
              {className: 'custom-tooltip'}
            );
            let clicUrl = getKeyIgnoreCase(extras, "Clic URL");
            if (clicUrl && clicUrl.trim().length > 0) {
              layer.on("click", () => window.open(clicUrl, '_blank'));
              layer.setStyle({ cursor: "pointer" });
            }
          }
        }).addTo(map);
        filterGeoLayer();
      })
      .catch(err => {
        alert(err.message);
        console.error(err);
        map.setView([46.6, 2.4], 6);
      });
  }
</script>
</body>
</html>
