<!DOCTYPE html>
<html>
<head>
  <title>Carte interactive codes postaux France</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    body { margin:0; padding:0; display: flex; height: 100vh; overflow: hidden; font-family: Arial, sans-serif; }
    #sidebar-left, #sidebar-right {
      width: 250px;
      background: #f7f7f7;
      overflow-y: auto;
      padding: 10px;
      box-shadow: 2px 0 5px rgba(0,0,0,0.1);
      font-size: 14px;
      transition: max-height 0.3s ease;
    }
    #sidebar-left {
      border-right: 1px solid #ccc;
    }
    #sidebar-right {
      border-left: 1px solid #ccc;
    }
    #map {
      flex-grow: 1;
      height: 100vh;
    }
    h2 {
      margin-top: 0; font-size: 18px; margin-bottom: 10px; border-bottom: 1px solid #ccc; padding-bottom: 4px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      user-select: none;
      cursor: pointer;
    }
    label {
      display: block;
      margin-bottom: 6px;
      cursor: pointer;
      user-select: none;
    }
    #controls {
      padding:10px; background:#fff; position: sticky; top: 0; z-index: 1000; border-bottom: 1px solid #ddd; margin-bottom: 10px;
    }
    .custom-tooltip {
      font-weight: bold;
    }
    .selectall-label {
      font-weight: bold;
      margin-top: 6px;
      border-bottom: 1px solid #ddd;
      padding-bottom: 2px;
      cursor: pointer;
      user-select: none;
    }
    .toggle-btn {
      font-size: 14px;
      background: #007bff;
      border: none;
      color: white;
      padding: 2px 8px;
      border-radius: 4px;
      cursor: pointer;
      user-select: none;
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <div id="sidebar-left">
    <div id="controls">
      <input type="file" id="uploadExcel" accept=".xlsx" />
      <button id="convertBtn">Conversion JSON et Affichage</button>
    </div>

    <h2>Filtres Gauche
      <button class="toggle-btn" data-target="agenceList">Agence</button>
      <button class="toggle-btn" data-target="regionList">Région</button>
      <button class="toggle-btn" data-target="antenneList">Antenne</button>
    </h2>

    <div id="filter-agence">
      <label class="selectall-label"><input type="checkbox" id="agence-select-all" checked> Tout Agences</label>
      <div id="agenceList"></div>
    </div>

    <div id="filter-region">
      <label class="selectall-label"><input type="checkbox" id="region-select-all" checked> Tout Régions</label>
      <div id="regionList"></div>
    </div>

    <div id="filter-antenne">
      <label class="selectall-label"><input type="checkbox" id="antenne-select-all" checked> Tout Antennes</label>
      <div id="antenneList"></div>
    </div>
  </div>

  <div id="map"></div>

  <div id="sidebar-right">
    <h2>Filtres Droite
      <button class="toggle-btn" data-target="departementList">Département</button>
      <button class="toggle-btn" data-target="texte2List">Texte2</button>
    </h2>

    <div id="filter-departement">
      <label class="selectall-label"><input type="checkbox" id="departement-select-all" checked> Tout Départements</label>
      <div id="departementList"></div>
    </div>

    <div id="filter-texte2">
      <label class="selectall-label"><input type="checkbox" id="texte2-select-all" checked> Tout Texte2</label>
      <div id="texte2List"></div>
    </div>
  </div>

  <script>
    var map = L.map('map', { minZoom: 6 }).setView([46.6, 2.4], 6);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18,
      attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    let extraProperties = {};
    let geoLayer;

    // Structures pour stocker valeurs uniques par filtre
    let distinctValues = {
      agence: new Map(),
      region: new Map(),
      antenne: new Map(),
      departement: new Map(),
      texte2: new Map()
    };

    // Etat des filtres cochés
    let filterState = {
      agence: new Map(),
      region: new Map(),
      antenne: new Map(),
      departement: new Map(),
      texte2: new Map()
    };

    function getKeyIgnoreCase(obj, key) {
      key = key.toLowerCase().replace(/\s+/g, '');
      for (const k in obj) {
        if (k.toLowerCase().replace(/\s+/g, '') === key) return obj[k];
      }
      return null;
    }

    function buildFilterList(filterName, containerId) {
      const container = document.getElementById(containerId);
      container.innerHTML = '';
      const mapVals = distinctValues[filterName];
      mapVals.forEach((cpSet, val) => {
        const label = document.createElement('label');
        label.title = `${cpSet.size} codes postaux`;

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.checked = true;
        filterState[filterName].set(val, true);

        checkbox.addEventListener('change', () => {
          filterState[filterName].set(val, checkbox.checked);
          filterGeoLayer();
          updateSelectAllCheckbox(filterName);
        });

        label.appendChild(checkbox);
        label.appendChild(document.createTextNode(' ' + val));
        container.appendChild(label);
      });
    }

    function updateSelectAllCheckbox(filterName) {
      const selectAllCheckbox = document.getElementById(filterName + '-select-all');
      const values = Array.from(filterState[filterName].values());
      selectAllCheckbox.checked = values.every(v => v === true);
      selectAllCheckbox.indeterminate = values.some(v => v === true) && !selectAllCheckbox.checked;
    }

    function setupSelectAllListener(filterName) {
      const selectAllCheckbox = document.getElementById(filterName + '-select-all');
      selectAllCheckbox.addEventListener('change', () => {
        const checked = selectAllCheckbox.checked;
        filterState[filterName].forEach((_, key) => filterState[filterName].set(key, checked));

        const container = document.getElementById(filterName + 'List');
        Array.from(container.querySelectorAll('input[type="checkbox"]')).forEach(cb => {
          cb.checked = checked;
        });

        filterGeoLayer();
      });
    }

    function filterGeoLayer() {
      if (!geoLayer) return;
      geoLayer.eachLayer(layer => {
        let cp = layer.feature.properties.code_postal || layer.feature.properties.codePostal || layer.feature.properties.code || "";

        let extras = extraProperties[cp] || {};

        let valAgence = getKeyIgnoreCase(extras, "Agence") || "";
        let valRegion = getKeyIgnoreCase(extras, "région") || "";
        let valAntenne = getKeyIgnoreCase(extras, "Antenne") || "";
        let valDepartement = getKeyIgnoreCase(extras, "Departement") || "";
        let valTexte2 = getKeyIgnoreCase(extras, "Texte2") || "";

        let show = true;

        show = show && filterState.agence.get(valAgence) !== false;
        show = show && filterState.region.get(valRegion) !== false;
        show = show && filterState.antenne.get(valAntenne) !== false;
        show = show && filterState.departement.get(valDepartement) !== false;
        show = show && filterState.texte2.get(valTexte2) !== false;

        if (show) {
          layer.addTo(map);
        } else {
          map.removeLayer(layer);
        }
      });
    }

    function updateDistinctValues(jsonData) {
      for (const key in distinctValues) {
        distinctValues[key].clear();
        filterState[key].clear();
      }

      jsonData.forEach(item => {
        const cp = (item["Code Postal"] || "").toString();
        if (!cp) return;

        const ag = getKeyIgnoreCase(item, "Agence") || "";
        const re = getKeyIgnoreCase(item, "région") || "";
        const an = getKeyIgnoreCase(item, "Antenne") || "";
        const dep = getKeyIgnoreCase(item, "Departement") || "";
        const tx2 = getKeyIgnoreCase(item, "Texte2") || "";

        if (!distinctValues.agence.has(ag)) distinctValues.agence.set(ag, new Set());
        distinctValues.agence.get(ag).add(cp);

        if (!distinctValues.region.has(re)) distinctValues.region.set(re, new Set());
        distinctValues.region.get(re).add(cp);

        if (!distinctValues.antenne.has(an)) distinctValues.antenne.set(an, new Set());
        distinctValues.antenne.get(an).add(cp);

        if (!distinctValues.departement.has(dep)) distinctValues.departement.set(dep, new Set());
        distinctValues.departement.get(dep).add(cp);

        if (!distinctValues.texte2.has(tx2)) distinctValues.texte2.set(tx2, new Set());
        distinctValues.texte2.get(tx2).add(cp);
      });
    }

    function buildFilterLists() {
      buildFilterList('agence', 'agenceList');
      buildFilterList('region', 'regionList');
      buildFilterList('antenne', 'antenneList');
      buildFilterList('departement', 'departementList');
      buildFilterList('texte2', 'texte2List');

      ['agence', 'region', 'antenne', 'departement', 'texte2'].forEach(filt => {
        updateSelectAllCheckbox(filt);
        setupSelectAllListener(filt);
      });
    }

    function toggleListVisibility(button) {
      const target = button.getAttribute('data-target');
      const el = document.getElementById(target);
      if(!el) return;
      if(el.style.display === 'none') {
        el.style.display = 'block';
        button.textContent = button.getAttribute('data-label-hide');
      } else {
        el.style.display = 'none';
        button.textContent = button.getAttribute('data-label-show');
      }
    }

    // Ajout des listeners toggle sur boutons
    function setupToggleButtons() {
      const buttons = document.querySelectorAll('.toggle-btn');
      buttons.forEach(btn => {
        btn.addEventListener('click', () => toggleListVisibility(btn));
        // Initialisation labels
        btn.setAttribute('data-label-show', btn.textContent);
        btn.setAttribute('data-label-hide', 'Masquer');
      });
    }

    function updateMapWithExtraProperties() {
      fetch('contours-codes-postaux.geojson')
        .then(res => {
          if (!res.ok) throw new Error("Le fichier GeoJSON n'a pas été chargé correctement.");
          return res.json();
        })
        .then(data => {
          if (geoLayer) map.removeLayer(geoLayer);

          geoLayer = L.geoJSON(data, {
            style: function(feature) {
              let cp = feature.properties.code_postal || feature.properties.codePostal || feature.properties.code || "";
              let extras = extraProperties[cp] || {};
              return {
                fillColor: getKeyIgnoreCase(extras, "Fond_couleur") || "#66cc66",
                color: getKeyIgnoreCase(extras, "Ligne_couleur") || "#000000",
                weight: 1,
                opacity: 1,
                fillOpacity: 0.7
              };
            },
            onEachFeature: function(feature, layer) {
              let cp = feature.properties.code_postal || feature.properties.codePostal || feature.properties.code || "";
              let extras = extraProperties[cp] || {};

              let texteParts = [];
              ["Texte1", "Texte2", "Texte3", "Texte4"].forEach(field => {
                let val = getKeyIgnoreCase(extras, field);
                if (val) texteParts.push(val);
              });

              let tooltipText = texteParts.join(" ");
              let policeCouleur = getKeyIgnoreCase(extras, "police couleur") || '#000000';

              layer.bindTooltip(
                `<span style="color: ${policeCouleur};">${tooltipText || ("Code Postal : " + cp)}</span>`,
                {className: 'custom-tooltip'}
              );

              let clicUrl = getKeyIgnoreCase(extras, "Clic URL");
              if (clicUrl && clicUrl.trim().length > 0) {
                layer.on("click", function() {
                  window.open(clicUrl, '_blank');
                });
                layer.setStyle({ cursor: "pointer" });
              }
            }
          }).addTo(map);

          map.fitBounds(geoLayer.getBounds());
          filterGeoLayer();
        })
        .catch(err => {
          alert(err.message);
          console.error(err);
        });
    }

    document.getElementById('convertBtn').onclick = function() {
      let fileInput = document.getElementById('uploadExcel');
      let file = fileInput.files[0];
      if (!file) {
        alert("Sélectionnez un fichier Excel (.xlsx) à convertir avant de cliquer.");
        return;
      }
      var reader = new FileReader();
      reader.onload = function(e) {
        var data = new Uint8Array(e.target.result);
        var workbook = XLSX.read(data, {type: 'array'});
        var firstSheetName = workbook.SheetNames[0];
        var sheet = workbook.Sheets[firstSheetName];
        var jsonData = XLSX.utils.sheet_to_json(sheet);

        extraProperties = {};
        updateDistinctValues(jsonData);

        jsonData.forEach(function(item) {
          let cp = (item["Code Postal"] || "").toString();
          if (cp.length > 0) extraProperties[cp] = item;
        });

        buildFilterLists();
        setupToggleButtons();
        updateMapWithExtraProperties();
        alert("Conversion et affichage réalisés !");
      };
      reader.readAsArrayBuffer(file);
    };
  </script>
</body>
</html>
