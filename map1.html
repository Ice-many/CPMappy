<!DOCTYPE html>
<html>
<head>
  <title>Carte interactive codes postaux France</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    html, body { margin:0; padding:0; height:100%; font-family: Arial, sans-serif; overflow:hidden; }
    body { display:flex; height:100vh; user-select:none; }
    #sidebar-left, #sidebar-right {
      background:#000; color:white; overflow-y:auto; padding:10px;
      box-shadow:2px 0 5px rgba(0,0,0,0.3); font-size:14px;
      min-width:180px; max-width:400px; resize:horizontal; overflow:auto;
    }
    #sidebar-left { border-right:1px solid #444; width:250px; }
    #sidebar-right { border-left:1px solid #444; width:250px; }
    #map { flex-grow:1; height:100vh; }
    label { display:block; margin-bottom:6px; cursor:pointer; user-select:text; color:white; }
    #controls { padding:10px; background:#111; position:sticky; top:0; z-index:1000; border-bottom:1px solid #444; margin-bottom:10px; color:white; }
    .custom-tooltip { font-weight:bold; }
    .selectall-label { font-weight:bold; margin-top:6px; border-bottom:1px solid #444; padding-bottom:2px; cursor:pointer; }
    .toggle-btn { font-size:14px; background:#6a0dad; border:none; color:white; padding:4px 10px; border-radius:4px; cursor:pointer; margin:10px 0 6px 0; width:100%; text-align:left; }
    #toggleLeftBtn, #toggleRightBtn { position:fixed; top:10px; padding:8px 14px; font-size:14px; border-radius:4px; cursor:pointer; z-index:1300; box-shadow:0 2px 8px rgba(0,191,255,0.7); color:white; background-color:#00bfff; transition:background-color 0.3s ease; }
    #toggleLeftBtn.violet, #toggleRightBtn.violet { background-color:#6a0dad !important; box-shadow:0 2px 8px rgba(106,13,173,0.7) !important; }
    #toggleLeftBtn { left:10px; } #toggleRightBtn { right:10px; }
    .hidden { display:none !important; }
  </style>
</head>
<body>

<button id="toggleLeftBtn" title="Afficher/Masquer Réseau">Réseau</button>
<button id="toggleRightBtn" title="Afficher/Masquer Département">Département</button>

<div id="sidebar-left">
  <div id="controls">
    <input type="file" id="uploadExcel" accept=".xlsx" />
    <button id="convertBtn">Conversion JSON et Affichage</button>
  </div>

  <button class="toggle-btn" data-target="region">Région</button>
  <div id="filter-region" class="hidden">
    <label class="selectall-label"><input type="checkbox" id="region-select-all" checked> Tout Régions</label>
    <div id="regionList"></div>
  </div>

  <button class="toggle-btn" data-target="agence">Agence</button>
  <div id="filter-agence" class="hidden">
    <label class="selectall-label"><input type="checkbox" id="agence-select-all" checked> Tout Agences</label>
    <div id="agenceList"></div>
  </div>

  <button class="toggle-btn" data-target="antenne">Antenne</button>
  <div id="filter-antenne" class="hidden">
    <label class="selectall-label"><input type="checkbox" id="antenne-select-all" checked> Tout Antennes</label>
    <div id="antenneList"></div>
  </div>

  <button class="toggle-btn" data-target="dsp">DSP</button>
  <div id="filter-dsp" class="hidden">
    <label class="selectall-label"><input type="checkbox" id="dsp-select-all" checked> Tout DSP</label>
    <div id="dspList"></div>
  </div>

  <button class="toggle-btn" data-target="canaldis">Canal DIS</button>
  <div id="filter-canaldis" class="hidden">
    <label class="selectall-label"><input type="checkbox" id="canaldis-select-all" checked> Tout Canal DIS</label>
    <div id="canaldisList"></div>
  </div>
</div>

<div id="map"></div>

<div id="sidebar-right">
  <button class="toggle-btn" data-target="departement">Département</button>
  <div id="filter-departement" class="hidden">
    <label><input type="checkbox" id="contourCP" checked> Contour CP</label>
    <label class="selectall-label"><input type="checkbox" id="departement-select-all" checked> Tout Départements</label>
    <div id="departementList"></div>
  </div>

  <button class="toggle-btn" data-target="texte2">Nom département</button>
  <div id="filter-texte2" class="hidden">
    <label class="selectall-label"><input type="checkbox" id="texte2-select-all" checked> Tout Nom département</label>
    <div id="texte2List"></div>
  </div>
</div>

<script>
var map = L.map('map',{minZoom:6,center:[46.6,2.4],zoom:6});
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:18,attribution:'© OpenStreetMap contributors'}).addTo(map);

let extraProperties={}, geoLayer;
let distinctValues={region:new Map(), agence:new Map(), antenne:new Map(), dsp:new Map(), canaldis:new Map(), departement:new Map(), texte2:new Map()};
let filterState={region:new Map(), agence:new Map(), antenne:new Map(), dsp:new Map(), canaldis:new Map(), departement:new Map(), texte2:new Map()};

function getKeyIgnoreCase(obj,key){ key=key.toLowerCase().replace(/\s+/g,''); for(const k in obj) if(k.toLowerCase().replace(/\s+/g,'')===key) return obj[k]; return null; }

// Construction des filtres
function buildFilterList(filterName, containerId){
  const container=document.getElementById(containerId); container.innerHTML='';
  const mapVals=distinctValues[filterName];
  const items=Array.from(mapVals.keys());
  items.sort((a,b)=>a.localeCompare(b,'fr',{sensitivity:'base'})).forEach(val=>{
    if(!filterState[filterName].has(val)) filterState[filterName].set(val,true);
    const label=document.createElement('label');
    const checkbox=document.createElement('input'); checkbox.type='checkbox'; checkbox.checked=filterState[filterName].get(val)!==false;
    checkbox.addEventListener('change',()=>{ filterState[filterName].set(val,checkbox.checked); filterGeoLayer(); });
    label.appendChild(checkbox); label.appendChild(document.createTextNode(' '+val));
    container.appendChild(label);
  });
}

function updateDistinctValues(jsonData){
  Object.keys(distinctValues).forEach(k=>{ distinctValues[k].clear(); filterState[k].clear(); });
  jsonData.forEach(item=>{
    const cp=(item["Code Postal"]||"").toString(); if(!cp) return;
    ["Agence","région","Antenne","DSP","Canal DIS","Departement","Texte2"].forEach(key=>{
      const val=getKeyIgnoreCase(item,key)||"";
      if(!distinctValues[key.toLowerCase()].has(val)) distinctValues[key.toLowerCase()].set(val,new Set());
      distinctValues[key.toLowerCase()].get(val).add(cp);
    });
  });
}

function buildFilterLists(){
  ["region","agence","antenne","dsp","canaldis","departement","texte2"].forEach(f=>buildFilterList(f,f+"List"));
}

// Gestion du contour CP
function filterGeoLayer(){
  if(!geoLayer) return;
  const contourChecked=document.getElementById('contourCP').checked;
  geoLayer.eachLayer(layer=>{
    const cp=layer.feature.properties.code_postal||layer.feature.properties.codePostal||layer.feature.properties.code||"";
    const extras=extraProperties[cp]||{};
    const valRegion=getKeyIgnoreCase(extras,"région")||"";
    const valAgence=getKeyIgnoreCase(extras,"Agence")||"";
    const valAntenne=getKeyIgnoreCase(extras,"Antenne")||"";
    const valDSP=getKeyIgnoreCase(extras,"DSP")||"";
    const valCanalDIS=getKeyIgnoreCase(extras,"Canal DIS")||"";
    const valDepartement=getKeyIgnoreCase(extras,"Departement")||"";
    const valTexte2=getKeyIgnoreCase(extras,"Texte2")||"";
    const show=filterState.region.get(valRegion)!==false &&
               filterState.agence.get(valAgence)!==false &&
               filterState.antenne.get(valAntenne)!==false &&
               filterState.dsp.get(valDSP)!==false &&
               filterState.canaldis.get(valCanalDIS)!==false &&
               filterState.departement.get(valDepartement)!==false &&
               filterState.texte2.get(valTexte2)!==false;
    layer.setStyle({weight:contourChecked?1:0});
    if(show) layer.addTo(map); else map.removeLayer(layer);
  });
}

// Boutons violets déjà dans CSS (.toggle-btn { background:#6a0dad; })
document.querySelectorAll('.toggle-btn').forEach(btn=>btn.style.background="#6a0dad");

// Chargement fichier Excel
document.getElementById('uploadExcel').addEventListener('change',(e)=>{
  if(e.target.files.length>0){ document.getElementById('convertBtn').click(); }
});

// Conversion Excel -> JSON
document.getElementById('convertBtn').onclick=()=>{
  const file=document.getElementById('uploadExcel').files[0]; if(!file) return;
  const reader=new FileReader();
  reader.onload=e=>{
    const data=new Uint8Array(e.target.result);
    const workbook=XLSX.read(data,{type:'array'});
    const sheet=workbook.Sheets[workbook.SheetNames[0]];
    const jsonData=XLSX.utils.sheet_to_json(sheet);
    extraProperties={}; updateDistinctValues(jsonData);
    jsonData.forEach(item=>{ const cp=(item["Code Postal"]||"").toString(); if(cp) extraProperties[cp]=item; });
    buildFilterLists(); updateMapWithExtraProperties();
  };
  reader.readAsArrayBuffer(file);
};

// Chargement GeoJSON
function updateMapWithExtraProperties(){
  fetch('contours-codes-postaux.geojson')
    .then(res=>res.json())
    .then(data=>{
      if(geoLayer) geoLayer.remove();
      geoLayer=L.geoJSON(data,{
        style: feature=>{
          const cp=feature.properties.code_postal||feature.properties.codePostal||feature.properties.code||"";
          const extras=extraProperties[cp]||{};
          const contourChecked=document.getElementById('contourCP').checked;
          return { fillColor:getKeyIgnoreCase(extras,"Fond_couleur")||"#66cc66", color:getKeyIgnoreCase(extras,"Ligne_couleur")||"#000000", weight:contourChecked?1:0, fillOpacity:0.7 };
        },
        onEachFeature: (feature,layer)=>{
          const cp=feature.properties.code_postal||feature.properties.codePostal||feature.properties.code||"";
          const extras=extraProperties[cp]||{};
          let texteParts=[]; ["Texte1","Texte2","Texte3","Texte4"].forEach(f=>{ const v=getKeyIgnoreCase(extras,f); if(v) texteParts.push(v); });
          layer.bindTooltip(texteParts.join(" ")||("Code Postal : "+cp));
        }
      }).addTo(map);
      filterGeoLayer();
    });
}

document.getElementById('contourCP').addEventListener('change',filterGeoLayer);
</script>
</body>
</html>
