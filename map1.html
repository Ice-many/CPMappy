<!DOCTYPE html>
<html>
<head>
  <title>Carte interactive codes postaux France</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    html, body {
      margin: 0; padding: 0; height: 100%;
      font-family: Arial, sans-serif;
      overflow: hidden;
    }
    body {
      display: flex;
      height: 100vh;
      user-select: none;
    }
    #sidebar-left, #sidebar-right {
      background: #000; /* fond noir */
      color: white;
      overflow-y: auto;
      padding: 10px;
      box-shadow: 2px 0 5px rgba(0,0,0,0.3);
      font-size: 14px;
      min-width: 180px;
      max-width: 400px;
      resize: horizontal;
      overflow: auto;
    }
    #sidebar-left {
      border-right: 1px solid #444;
      width: 280px;
    }
    #sidebar-right {
      border-left: 1px solid #444;
      width: 250px;
    }
    #map {
      flex-grow: 1;
      height: 100vh;
    }
    label {
      display: block;
      margin-bottom: 6px;
      cursor: pointer;
      user-select: text;
      color: white;
    }
    #controls {
      padding: 10px;
      background: #111;
      position: sticky;
      top: 0;
      z-index: 1000;
      border-bottom: 1px solid #444;
      margin-bottom: 10px;
      user-select: none;
      color: white;
    }
    .custom-tooltip {
      font-weight: bold;
    }
    .selectall-label {
      font-weight: bold;
      margin-top: 6px;
      border-bottom: 1px solid #444;
      padding-bottom: 2px;
      cursor: pointer;
      user-select: none;
      color: white;
    }
    .toggle-btn {
      font-size: 14px;
      background: #007bff;
      border: none;
      color: white;
      padding: 4px 10px;
      border-radius: 4px;
      cursor: pointer;
      user-select: none;
      margin: 10px 0 6px 0;
      width: 100%;
      text-align: left;
    }
    #toggleLeftBtn, #toggleRightBtn {
      position: fixed;
      top: 10px;
      padding: 8px 14px;
      font-size: 14px;
      border-radius: 4px;
      cursor: pointer;
      z-index: 1300;
      user-select: none;
      box-shadow: 0 2px 8px rgba(106,13,173,0.7);
      color: white;
      background-color: #6a0dad;
      transition: background-color 0.3s ease;
    }
    #toggleLeftBtn { left: 10px; }
    #toggleRightBtn { right: 10px; }
    #toggleLeftBtn.active, #toggleRightBtn.active {
      background-color: #00bfff;
      box-shadow: 0 2px 8px rgba(0,191,255,0.7);
    }
    .hidden { display: none !important; }
  </style>
</head>
<body>

<button id="toggleLeftBtn" title="Afficher/Masquer Réseau">Réseau</button>
<button id="toggleRightBtn" title="Afficher/Masquer Département">Département</button>

<div id="sidebar-left">
  <div id="controls">
    <input type="file" id="uploadExcel" accept=".xlsx" />
    <button id="convertBtn">Conversion et Affichage</button>
  </div>

  <button class="toggle-btn" data-target="agence">Agence</button>
  <div id="filter-agence" class="hidden">
    <label class="selectall-label"><input type="checkbox" id="agence-select-all" /> Tout Agences</label>
    <div id="agenceList"></div>
  </div>

  <button class="toggle-btn" data-target="region">Région</button>
  <div id="filter-region" class="hidden">
    <label class="selectall-label"><input type="checkbox" id="region-select-all" /> Tout Régions</label>
    <div id="regionList"></div>
  </div>

  <button class="toggle-btn" data-target="antenne">Antenne</button>
  <div id="filter-antenne" class="hidden">
    <label class="selectall-label"><input type="checkbox" id="antenne-select-all" /> Tout Antennes</label>
    <div id="antenneList"></div>
  </div>

  <button class="toggle-btn" data-target="dsp">DSP</button>
  <div id="filter-dsp" class="hidden">
    <label class="selectall-label"><input type="checkbox" id="dsp-select-all" /> Tout DSP</label>
    <div id="dspList"></div>
  </div>

</div>

<div id="map"></div>

<div id="sidebar-right">
  <button class="toggle-btn" data-target="departement">Département</button>
  <div id="filter-departement" class="hidden">
    <label class="selectall-label"><input type="checkbox" id="departement-select-all" /> Tout Départements</label>
    <div id="departementList"></div>
  </div>

  <button class="toggle-btn" data-target="texte2">Texte2</button>
  <div id="filter-texte2" class="hidden">
    <label class="selectall-label"><input type="checkbox" id="texte2-select-all" /> Tout Texte2</label>
    <div id="texte2List"></div>
  </div>
</div>

<script>
  var map = L.map('map', { minZoom: 6, center: [46.5, 2.5], zoom: 6 });

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 18,
    attribution: '© OpenStreetMap contributors'
  }).addTo(map);

  let extraProperties = {};
  let geoLayer;

  let distinctValues = {
    agence: new Map(),
    region: new Map(),
    antenne: new Map(),
    dsp: new Map(),
    departement: new Map(),
    texte2: new Map()
  };

  let filterState = {
    agence: new Map(),
    region: new Map(),
    antenne: new Map(),
    dsp: new Map(),
    departement: new Map(),
    texte2: new Map()
  };

  function getValueCI(obj, key) {
    if (!obj) return "";
    key = key.toLowerCase().replace(/\s+/g, '');
    for (const k in obj) {
      if (k.toLowerCase().replace(/\s+/g, '') === key) return obj[k];
    }
    return "";
  }

  function buildFilterList(filterName, containerId) {
    const container = document.getElementById(containerId);
    container.innerHTML = "";
    const valsMap = distinctValues[filterName];
    if (!valsMap) return;
    let vals = Array.from(valsMap.keys());
    vals.sort((a,b) => a.localeCompare(b, undefined, {ignorePunctuation: true}));

    for (let val of vals) {
      let setCP = valsMap.get(val);
      let label = document.createElement("label");
      label.title = `${setCP.size} codes postaux`;
      let cb = document.createElement("input");
      cb.type = "checkbox";
      cb.checked = true;

      filterState[filterName].set(val, true);

      cb.addEventListener("change", () => {
        filterState[filterName].set(val, cb.checked);
        updateSelectAllCheckbox(filterName);
        filterMap();
      });

      label.appendChild(cb);
      label.appendChild(document.createTextNode(" " + val));
      container.appendChild(label);
    }
  }

  function updateSelectAllCheckbox(filterName) {
    let selAll = document.getElementById(filterName + "-select-all");
    if (!selAll) return;
    let vals = Array.from(filterState[filterName].values());
    let allChecked = vals.length > 0 && vals.every(v => v === true);
    selAll.checked = allChecked;
    selAll.indeterminate = !allChecked && vals.some(v => v === true);
  }

  function setupSelectAllListener(filterName) {
    let selAll = document.getElementById(filterName + "-select-all");
    if (!selAll) return;
    selAll.addEventListener("change", () => {
      let checked = selAll.checked;
      let container = document.getElementById(filterName + "List");
      for (let kv of filterState[filterName].keys()) {
        filterState[filterName].set(kv, checked);
      }
      if (container) {
        let cbs = container.querySelectorAll("input[type=checkbox]");
        cbs.forEach(cb => (cb.checked = checked));
      }
      filterMap();
    });
  }

  function setupFilterToggles() {
    let btns = document.querySelectorAll(".toggle-btn");
    btns.forEach(btn => {
      let target = btn.getAttribute("data-target");
      btn.textContent = target[0].toUpperCase() + target.slice(1);
      btn.addEventListener("click", () => {
        let el = document.getElementById("filter-" + target);
        if (!el) return;
        if (el.classList.contains("hidden")) {
          el.classList.remove("hidden");
          btn.textContent = "Masquer " + target[0].toUpperCase() + target.slice(1);
        } else {
          el.classList.add("hidden");
          btn.textContent = target[0].toUpperCase() + target.slice(1);
        }
      });
    });
  }

  document.getElementById("toggleLeftBtn").addEventListener("click", () => {
    let btn = document.getElementById("toggleLeftBtn");
    let sidebar = document.getElementById("sidebar-left");
    if (sidebar.style.display === "none") {
      sidebar.style.display = "block";
      btn.classList.remove("active");
    } else {
      sidebar.style.display = "none";
      btn.classList.add("active");
    }
    filterMap();
  });

  document.getElementById("toggleRightBtn").addEventListener("click", () => {
    let btn = document.getElementById("toggleRightBtn");
    let sidebar = document.getElementById("sidebar-right");
    if (sidebar.style.display === "none") {
      sidebar.style.display = "block";
      btn.classList.remove("active");
    } else {
      sidebar.style.display = "none";
      btn.classList.add("active");
    }
    filterMap();
  });

  function filterMap() {
    if (!geoLayer) return;
    geoLayer.eachLayer(layer => {
      let cp = layer.feature.properties.code_postal || layer.feature.properties.codePostal || layer.feature.properties.code || "";
      let extras = extraProperties[cp];

      if (!extras) {
        if (layer._map) layer._map.removeLayer(layer);
        return;
      }

      let valAg = getValueCI(extras, "Agence");
      let valR = getValueCI(extras, "région");
      let valAn = getValueCI(extras, "Antenne");
      let valDSP = getValueCI(extras, "DSP");
      let valDep = getValueCI(extras, "Departement");
      let valT2 = getValueCI(extras, "Texte2");

      let visible =
        filterState.agence.get(valAg) !== false &&
        filterState.region.get(valR) !== false &&
        filterState.antenne.get(valAn) !== false &&
        filterState.dsp.get(valDSP) !== false &&
        filterState.departement.get(valDep) !== false &&
        filterState.texte2.get(valT2) !== false;

      if (visible) {
        if (!layer._map) layer.addTo(map);
      } else {
        if (layer._map) layer.remove();
      }
    });
  }

  function updateDistinct(vals) {
    for (let key in distinctValues) {
      distinctValues[key].clear();
      filterState[key].clear();
    }
    vals.forEach(item => {
      let cp = (item["Code Postal"] || "").toString();
      if (!cp) return;
      let ag = getValueCI(item, "Agence");
      let r = getValueCI(item, "région");
      let an = getValueCI(item, "Antenne");
      let dsp = getValueCI(item, "DSP");
      let dep = getValueCI(item, "Departement");
      let t2 = getValueCI(item, "Texte2");

      if (!distinctValues.agence.has(ag)) distinctValues.agence.set(ag, new Set());
      distinctValues.agence.get(ag).add(cp);

      if (!distinctValues.region.has(r)) distinctValues.region.set(r, new Set());
      distinctValues.region.get(r).add(cp);

      if (!distinctValues.antenne.has(an)) distinctValues.antenne.set(an, new Set());
      distinctValues.antenne.get(an).add(cp);

      if (!distinctValues.dsp.has(dsp)) distinctValues.dsp.set(dsp, new Set());
      distinctValues.dsp.get(dsp).add(cp);

      if (!distinctValues.departement.has(dep)) distinctValues.departement.set(dep, new Set());
      distinctValues.departement.get(dep).add(cp);

      if (!distinctValues.texte2.has(t2)) distinctValues.texte2.set(t2, new Set());
      distinctValues.texte2.get(t2).add(cp);
    });
  }

  function populateFilters() {
    ["agence", "region", "antenne", "dsp", "departement", "texte2"].forEach(f => {
      buildFilterList(f, f + "List");
      updateSelectAllCheckbox(f);
      setupSelectAllListener(f);
    });
  }

  document.getElementById("toggleLeftBtn").addEventListener("click", function () {
    let sidebar = document.getElementById("sidebar-left");
    this.classList.toggle("active");
    sidebar.style.display = sidebar.style.display === "none" ? "block" : "none";
    filterMap();
  });

  document.getElementById("toggleRightBtn").addEventListener("click", function () {
    let sidebar = document.getElementById("sidebar-right");
    this.classList.toggle("active");
    sidebar.style.display = sidebar.style.display === "none" ? "block" : "none";
    filterMap();
  });

  function setupToggleButtons() {
    let buttons = document.querySelectorAll(".toggle-btn");
    buttons.forEach(btn => {
      let target = btn.getAttribute("data-target");
      btn.textContent = target[0].toUpperCase() + target.slice(1);
      btn.addEventListener("click", () => {
        let el = document.getElementById("filter-" + target);
        if (!el) return;
        if (el.classList.contains("hidden")) {
          el.classList.remove("hidden");
          btn.textContent = "Masquer " + target[0].toUpperCase() + target.slice(1);
        } else {
          el.classList.add("hidden");
          btn.textContent = target[0].toUpperCase() + target.slice(1);
        }
      });
    });
  }

  document.getElementById("convertBtn").addEventListener("click", function () {
    let input = document.getElementById("uploadExcel");
    if (input.files.length === 0) {
      alert("Veuillez sélectionner un fichier Excel.");
      return;
    }

    let reader = new FileReader();
    reader.onload = function (e) {
      let data = new Uint8Array(e.target.result);
      let workbook = XLSX.read(data, { type: "array" });
      let firstSheet = workbook.SheetNames[0];
      let sheet = workbook.Sheets[firstSheet];
      let json = XLSX.utils.sheet_to_json(sheet);

      extraProperties = {};
      updateDistinct(json);

      json.forEach(item => {
        let cp = (item["Code Postal"] || "").toString();
        if (!cp) return;
        extraProperties[cp] = item;
      });

      populateFilters();
      setupToggleButtons();

      map.setView([46.5, 2.5], 6);

      fetch("contours.geojson").then(res => res.json()).then(data => {
        if (geoLayer) geoLayer.remove();
        geoLayer = L.geoJSON(data, {
          style: f => {
            let cp = f.properties.code_postal || f.properties.codePostal || f.properties.code || "";
            let extras = extraProperties[cp];
            return {
              fillColor: (extras ? extras["DSP_Couleur"] || "#6688CC" : "#6688CC"),
              color: (extras ? extras["Ligne_Couleur"] || "#000000" : "#000000"),
              weight: 1,
              opacity: 1,
              fillOpacity: 0.7,
            };
          },
          onEachFeature: (feature, layer) => {
            let cp = feature.properties.code_postal || feature.properties.codePostal || feature.properties.code || "";
            let extras = extraProperties[cp];
            if (!extras) return;
            let texts = [];
            for (let i = 1; i <= 4; i++) {
              let t = extras[`Texte${i}`];
              if (t) texts.push(t);
            }
            let textColor = extras["Police_Couleur"] || "#000000";
            layer.bindTooltip(`<span style="color:${textColor}">${texts.join(" ")}</span>`);
            if (extras["Clic_URL"]) {
              layer.on("click", () => window.open(extras["Clic_URL"], "_blank"));
              layer.setStyle({ cursor: "pointer" });
            }
          }
        }).addTo(map);
        filterMap();
      });
      alert("Conversion et affichage réalisés!");
    };
    reader.readAsArrayBuffer(input.files[0]);
  });
</script>

</body>
</html>
