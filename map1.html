<!DOCTYPE html>
<html>
<head>
  <title>Carte interactive codes postaux France</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    html, body {margin:0; padding:0; height:100%; font-family:Arial,sans-serif; overflow:hidden;}
    body {display:flex; height:100vh; user-select:none;}
    #sidebar-left,#sidebar-right {background:#000; color:white; overflow-y:auto; padding:10px; box-shadow:2px 0 5px rgba(0,0,0,0.3);font-size:14px; min-width:180px; max-width:400px; resize:horizontal;}
    #sidebar-left {border-right:1px solid #444; width:250px;}
    #sidebar-right {border-left:1px solid #444; width:250px;}
    #map {flex-grow:1; height:100vh;}
    label {display:block; margin-bottom:6px; cursor:pointer; user-select:text; color:white;}
    #controls {padding:10px; background:#111; position:sticky; top:0; z-index:1000; border-bottom:1px solid #444; margin-bottom:10px; user-select:none; color:white;}
    .custom-tooltip {font-weight:bold;}
    .selectall-label {font-weight:bold; margin-top:6px; border-bottom:1px solid #444; padding-bottom:2px; cursor:pointer; user-select:none; color:white;}
    .toggle-btn {font-size:14px; background:#007bff; border:none; color:white; padding:4px 10px; border-radius:4px; cursor:pointer; user-select:none; margin:10px 0 6px; width:100%; text-align:left;}
    #toggleLeftBtn {
      position: fixed; top: 10px; left: 10px; z-index:1400; padding: 8px 14px; font-size: 14px; border-radius: 4px;
      cursor: pointer; user-select: none; background: #FFD700; color: black;
      box-shadow: 0 0 10px gold;
    }
    #toggleRightBtn {
      position: fixed; top: 10px; right: 10px; z-index:1400; padding: 8px 14px; font-size: 14px; border-radius: 4px;
      cursor: pointer; user-select: none; background: #00bfff; color: white;
      box-shadow: 0 0 10px deepskyblue;
    }
    .hidden {display:none !important;}
    input[disabled] {filter: grayscale(1) brightness(1.3);}
  </style>
</head>
<body>
<button id="toggleLeftBtn" title="Afficher/Masquer Réseau">Réseau</button>
<button id="toggleRightBtn" title="Afficher/Masquer Département">Département</button>

<div id="sidebar-left">
  <div id="controls">
    <input type="file" id="uploadExcel" accept=".xlsx" />
    <button id="convertBtn">Conversion JSON et Affichage</button>
  </div>

  <button class="toggle-btn" data-target="agence">Agence</button>
  <div id="filter-agence" class="hidden">
    <label class="selectall-label"><input type="checkbox" id="agence-select-all"> Tout Agences</label>
    <div id="agenceList"></div>
  </div>

  <button class="toggle-btn" data-target="region">Région</button>
  <div id="filter-region" class="hidden">
    <label class="selectall-label"><input type="checkbox" id="region-select-all"> Tout Régions</label>
    <div id="regionList"></div>
  </div>

  <button class="toggle-btn" data-target="antenne">Antenne</button>
  <div id="filter-antenne" class="hidden">
    <label class="selectall-label"><input type="checkbox" id="antenne-select-all"> Tout Antennes</label>
    <div id="antenneList"></div>
  </div>

  <button class="toggle-btn" data-target="dsp">DSP</button>
  <div id="filter-dsp" class="hidden">
    <label class="selectall-label"><input type="checkbox" id="dsp-select-all"> Tout DSP</label>
    <div id="dspList"></div>
  </div>

  <button class="toggle-btn" data-target="canaldis">Canal DIS</button>
  <div id="filter-canaldis" class="hidden">
    <label class="selectall-label"><input type="checkbox" id="canaldis-select-all"> Tout Canal DIS</label>
    <div id="canaldisList"></div>
  </div>
</div>

<div id="map"></div>

<div id="sidebar-right">
  <button class="toggle-btn" data-target="departement">Département</button>
  <div id="filter-departement" class="hidden">
    <label class="selectall-label"><input type="checkbox" id="departement-select-all"> Tout Départements</label>
    <div id="departementList"></div>
  </div>

  <button class="toggle-btn" data-target="texte2">Texte2</button>
  <div id="filter-texte2" class="hidden">
    <label class="selectall-label"><input type="checkbox" id="texte2-select-all"> Tout Texte2</label>
    <div id="texte2List"></div>
  </div>
</div>

<script>
var map = L.map('map', { minZoom: 6, center: [46.5, 2.5], zoom: 6 });

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 18,
  attribution: '© OpenStreetMap contributors'
}).addTo(map);

let extraProperties = {}, geoLayer;
const fields = ['agence', 'region', 'antenne', 'departement', 'texte2', 'dsp', 'canaldis'];
let distinctValues = {}, filterState = {};
fields.forEach(f => { distinctValues[f] = new Map(); filterState[f] = new Map(); });

function getKey(obj, key) {
  const lkey = key.toLowerCase().replace(/\s+/g,'');
  for (const k in obj) if (k.toLowerCase().replace(/\s+/g,'') === lkey) return obj[k];
  return '';
}

function getFilteredCPs() {
  let res = [];
  for(let cp in extraProperties){
    const ex = extraProperties[cp];
    if(!ex) continue;
    if(fields.every(f=> {
      const val = getKey(ex, f.charAt(0).toUpperCase() + f.slice(1));
      return !(filterState[f].has(val) && filterState[f].get(val) === false);
    })) res.push(cp);
  }
  return res;
}

function updateFiltersAndUI() {
  const validCPs = getFilteredCPs();

  const allowedValues = {};
  fields.forEach(f => allowedValues[f] = new Set());

  validCPs.forEach(cp => {
    const ex = extraProperties[cp];
    fields.forEach(f => {
      const val = getKey(ex, f.charAt(0).toUpperCase() + f.slice(1));
      if(val) allowedValues[f].add(val);
    });
  });

  fields.forEach(f => {
    const container = document.getElementById(f+'List');
    if(!container) return;
    container.innerHTML = '';

    // Show all values, disable those not allowed, keep checked per filterState
    const allValues = Array.from(distinctValues[f].keys()).sort();
    for(let val of allValues){
      const label = document.createElement('label');
      label.title = `${distinctValues[f].get(val).size} codes postaux`;

      const cb = document.createElement('input');
      cb.type = 'checkbox';
      // Initialize unchecked if missing, else use saved state
      if(!filterState[f].has(val)) filterState[f].set(val, true);
      cb.checked = filterState[f].get(val) === true;
      cb.disabled = !allowedValues[f].has(val);

      cb.addEventListener('change', () => {
        filterState[f].set(val, cb.checked);
        updateFiltersAndUI();
        filterMap();
      });

      label.appendChild(cb);
      label.appendChild(document.createTextNode(' '+val));
      container.appendChild(label);
    }

    updateSelectAll(f);
  });

  // Update map features
  if(!geoLayer) return;
  geoLayer.eachLayer(layer => {
    const cp = layer.feature.properties.code_postal || layer.feature.properties.codePostal || layer.feature.properties.code || '';
    if(validCPs.includes(cp)) {
      layer.addTo(map);
    } else {
      map.removeLayer(layer);
    }
  });
}

function updateSelectAll(f) {
  const selAll = document.getElementById(f+'-select-all');
  if(!selAll) return;
  const container = document.getElementById(f+'List');
  if(!container) return;

  const inputs = Array.from(container.querySelectorAll('input[type=checkbox]:not(:disabled)'));
  if(inputs.length === 0){
    selAll.checked = false;
    selAll.indeterminate = false;
    return;
  }
  const allChecked = inputs.every(cb => cb.checked);
  const anyChecked = inputs.some(cb => cb.checked);
  selAll.checked = allChecked;
  selAll.indeterminate = !allChecked && anyChecked;
}

function setupSelectAll() {
  fields.forEach(f=>{
    const selAll = document.getElementById(f+'-select-all');
    if(!selAll) return;
    selAll.addEventListener('change', ()=>{
      const container = document.getElementById(f+'List');
      const check = selAll.checked;
      if(!container) return;
      Array.from(container.querySelectorAll('input[type=checkbox]:not(:disabled)')).forEach(cb=>{
        cb.checked = check;
        filterState[f].set(cb.nextSibling.textContent.trim(), check);
      });
      updateFiltersAndUI();
      filterMap();
    });
  });
}

function filterMap(){
  if(!geoLayer) return;
  const validCPs = getFilteredCPs();
  geoLayer.eachLayer(layer => {
    const cp = layer.feature.properties.code_postal || layer.feature.properties.codePostal || layer.feature.properties.code || '';
    if(validCPs.includes(cp)){
      layer.addTo(map);
    } else {
      map.removeLayer(layer);
    }
  });
}

function buildFilters(){
  fields.forEach(f => {
    const container = document.getElementById(f+'List');
    if(!container) return;
    container.innerHTML = '';
    const allValues = Array.from(distinctValues[f].keys()).sort();
    for(let val of allValues){
      const label = document.createElement('label');
      label.title = `${distinctValues[f].get(val).size} codes postaux`;

      const cb = document.createElement('input');
      cb.type = 'checkbox';

      if(!filterState[f].has(val)) filterState[f].set(val, true);

      cb.checked = filterState[f].get(val) === true;
      cb.addEventListener('change', () => {
        filterState[f].set(val, cb.checked);
        updateFiltersAndUI();
        filterMap();
      });

      label.appendChild(cb);
      label.appendChild(document.createTextNode(' '+val));
      container.appendChild(label);
    }

    updateSelectAll(f);
  });
  setupSelectAll();
  setupToggleButtons();
}

function setupToggleButtons(){
  document.querySelectorAll('.toggle-btn').forEach(btn => {
    const target = btn.getAttribute('data-target');
    btn.textContent = target.charAt(0).toUpperCase() + target.slice(1);
    btn.addEventListener('click', () => {
      const elt = document.getElementById('filter-'+target);
      if(!elt) return;

      if(elt.classList.contains('hidden')){
        elt.classList.remove('hidden');
        btn.textContent = 'Masquer ' + target.charAt(0).toUpperCase() + target.slice(1);
      } else {
        elt.classList.add('hidden');
        btn.textContent = target.charAt(0).toUpperCase() + target.slice(1);
      }
    });
  });
}

document.getElementById('toggleLeftBtn').addEventListener('click', () => {
  const left = document.getElementById('sidebar-left');
  left.style.display = (left.style.display === 'none') ? 'block' : 'none';
});

document.getElementById('toggleRightBtn').addEventListener('click', () => {
  const right = document.getElementById('sidebar-right');
  right.style.display = (right.style.display === 'none') ? 'block' : 'none';
});

document.getElementById('convertBtn').addEventListener('click', () => {
  const input = document.getElementById('uploadExcel');
  const file = input.files[0];
  if(!file){
    alert("Veuillez sélectionner un fichier Excel (.xlsx)");
    return;
  }
  const reader = new FileReader();
  reader.onload = function(e){
    const data = new Uint8Array(e.target.result);
    const workbook = XLSX.read(data, {type:'array'});
    const firstSheet = workbook.SheetNames[0];
    const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[firstSheet]);

    extraProperties = {};
    for(const f of fields) {
      distinctValues[f].clear();
      filterState[f].clear();
    }

    jsonData.forEach(item => {
      const cp = item["Code Postal"] ? item["Code Postal"].toString() : "";
      if(!cp) return;
      extraProperties[cp] = item;
      fields.forEach(f => {
        const val = getKey(item, f.charAt(0).toUpperCase() + f.slice(1));
        if(!distinctValues[f].has(val)) distinctValues[f].set(val, new Set());
        distinctValues[f].get(val).add(cp);
      });
    });

    for(const f of fields){
      distinctValues[f].forEach((_,val) => {
        if(!filterState[f].has(val)) filterState[f].set(val, true);
      });
    }

    buildFilters();
    updateFiltersAndUI();
    filterMap();
    map.setView([46.5, 2.5], 6);

    setTimeout(() => alert("Conversion et affichage réalisés !"), 200);
  };
  reader.readAsArrayBuffer(file);
});

</script>
</body>
</html>
