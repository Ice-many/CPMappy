<!DOCTYPE html>
<html>
<head>
  <title>Carte interactive codes postaux France</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    html, body {
      margin: 0; padding: 0; height: 100%;
      font-family: Arial, sans-serif;
      overflow: hidden;
    }
    body {
      display: flex;
      height: 100vh;
      user-select: none;
    }
    #sidebar-left, #sidebar-right {
      background: #000;
      color: white;
      overflow-y: auto;
      padding: 10px;
      box-shadow: 2px 0 5px rgba(0,0,0,0.3);
      font-size: 14px;
      min-width: 180px;
      max-width: 400px;
      resize: horizontal;
      overflow: auto;
    }
    #sidebar-left {
      border-right: 1px solid #444;
      width: 280px;
    }
    #sidebar-right {
      border-left: 1px solid #444;
      width: 250px;
    }
    #map {
      flex-grow: 1;
      height: 100vh;
    }
    label {
      display: block;
      margin-bottom: 6px;
      cursor: pointer;
      user-select: text;
      color: white;
    }
    #control-panel {
      position: sticky;
      top: 0;
      background: #111;
      padding: 10px;
      margin-bottom: 10px;
      z-index: 1000;
      border-bottom: 1px solid #444;
      color: white;
      user-select: none;
    }
    .selectall-label {
      display: flex;
      align-items: center;
      margin-bottom: 6px;
      font-weight: bold;
      cursor: pointer;
      color: white;
      user-select: none;
    }
    .selectall-label input {
      margin-right: 8px;
    }
    .toggle-btn {
      font-size: 14px;
      background: #007bff;
      border: none;
      color: white;
      padding: 6px 10px;
      border-radius: 4px;
      cursor: pointer;
      user-select: none;
      margin: 10px 0 4px;
      width: 100%;
      text-align: left;
    }
    #toggleButtons {
      position: fixed;
      top: 10px;
      z-index: 1400;
      width: 280px;
      display: flex;
      justify-content: space-between;
      gap: 10px;
      left: 10px;
    }
    #toggleButtons button {
      flex: 1;
      padding: 8px 0;
      border: none;
      font-weight: bold;
      font-size: 14px;
      color: white;
      cursor: pointer;
      border-radius: 5px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      background-color: #6a0dad;
      transition: background-color 0.3s ease;
      user-select: none;
    }
    #toggleButtons button.active {
      background-color: #00bfff;
      box-shadow: 0 2px 6px rgba(0,191,255,0.7);
    }
    .hidden {
      display: none !important;
    }
  </style>
</head>
<body>

  <div id="toggleButtons">
    <button id="toggleLeftBtn" title="Afficher/masquer Réseau" class="active">Réseau</button>
    <button id="toggleRightBtn" title="Afficher/masquer Département" class="active">Département</button>
  </div>

  <div id="sidebar-left">
    <div id="control-panel">
      <input type="file" id="uploadExcel" accept=".xlsx" />
      <button id="convertBtn">Conversion et Affichage</button>
    </div>

    <button class="toggle-btn" data-target="agence">Agence</button>
    <div id="filter-agence" class="hidden"></div>

    <button class="toggle-btn" data-target="region">Région</button>
    <div id="filter-region" class="hidden"></div>

    <button class="toggle-btn" data-target="antenne">Antenne</button>
    <div id="filter-antenne" class="hidden"></div>

    <button class="toggle-btn" data-target="dsp">DSP</button>
    <div id="filter-dsp" class="hidden"></div>
  </div>

  <div id="sidebar-right">
    <button class="toggle-btn" data-target="departement">Département</button>
    <div id="filter-departement" class="hidden"></div>

    <button class="toggle-btn" data-target="texte2">Texte2</button>
    <div id="filter-texte2" class="hidden"></div>
  </div>

  <div id="map"></div>

<script>
  let map = L.map("map", { zoom: 6, minZoom: 6, center: [46.6, 2.4] });

  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 18,
    attribution: "© OpenStreetMap contributors",
  }).addTo(map);

  let geojsonLayer = null;
  let extraProperties = {};

  const distinctFields = ["agence", "region", "antenne", "dsp", "departement", "texte2"];
  const distinctValues = {
    agence: new Map(),
    region: new Map(),
    antenne: new Map(),
    dsp: new Map(),
    departement: new Map(),
    texte2: new Map(),
  };
  const filterState = {
    agence: new Map(),
    region: new Map(),
    antenne: new Map(),
    dsp: new Map(),
    departement: new Map(),
    texte2: new Map(),
  };

  function getFieldValueCI(obj, key) {
    if (!obj) return "";
    key = key.toLowerCase().replace(/\s+/g, "");
    for (let k in obj) {
      if (k.toLowerCase().replace(/\s+/g, "") === key) return obj[k];
    }
    return "";
  }

  function buildFilterList(field, containerId) {
    const container = document.getElementById(containerId);
    container.innerHTML = "";

    const values = distinctValues[field];
    if (!values) return;

    let sortedVals = Array.from(values.keys()).sort((a, b) =>
      a.localeCompare(b, undefined, { ignorePunctuation: true })
    );

    // 'Select All' checkbox creation
    const selectAllId = `${field}-select-all`;
    let selectAllContainer = document.createElement("div");
    selectAllContainer.className = "selectall-label";

    let selectAllCheckbox = document.getElementById(selectAllId);
    if (!selectAllCheckbox) {
      selectAllCheckbox = document.createElement("input");
      selectAllCheckbox.type = "checkbox";
      selectAllCheckbox.id = selectAllId;
      selectAllCheckbox.checked = true;
      selectAllContainer.appendChild(selectAllCheckbox);
      selectAllContainer.appendChild(document.createTextNode(` Tout ${field.charAt(0).toUpperCase() + field.slice(1)}`));
      container.appendChild(selectAllContainer);
    }

    selectAllCheckbox.addEventListener("change", () => {
      const checked = selectAllCheckbox.checked;
      filterState[field] = new Map([...distinctValues[field].keys()].map((v) => [v, checked]));
      updateFilterCheckboxes(field, checked);
      filterMap();
    });

    // Build individual checkboxes
    sortedVals.forEach((val) => {
      let label = document.createElement("label");
      label.title = `${values.get(val).size} codes postaux`;

      let checkbox = document.createElement("input");
      checkbox.type = "checkbox";
      checkbox.checked = true;

      filterState[field].set(val, true);

      checkbox.addEventListener("change", () => {
        filterState[field].set(val, checkbox.checked);
        updateSelectAllCheckbox(field);
        filterMap();
      });

      label.appendChild(checkbox);
      label.appendChild(document.createTextNode(" " + val));
      container.appendChild(label);
    });
  }

  function updateFilterCheckboxes(field, state) {
    const container = document.getElementById(`${field}List`);
    if (!container) return;
    const checkboxes = container.querySelectorAll("input[type='checkbox']");
    checkboxes.forEach((cb) => {
      cb.checked = state;
    });
    updateSelectAllCheckbox(field);
  }

  function updateSelectAllCheckbox(field) {
    const selectAll = document.getElementById(`${field}-select-all`);
    if (!selectAll) return;
    const vals = Array.from(filterState[field].values());
    const allChecked = vals.length > 0 && vals.every((v) => v === true);
    selectAll.checked = allChecked;
    selectAll.indeterminate = !allChecked && vals.some((v) => v === true);
  }

  function setupFilterToggles() {
    document.querySelectorAll(".toggle-btn").forEach((btn) => {
      const target = btn.getAttribute("data-target");
      btn.textContent = target.charAt(0).toUpperCase() + target.slice(1);
      btn.addEventListener("click", () => {
        const filterDiv = document.getElementById("filter-" + target);
        if (!filterDiv) return;
        if (filterDiv.classList.contains("hidden")) {
          filterDiv.classList.remove("hidden");
          btn.textContent = "Masquer " + target.charAt(0).toUpperCase() + target.slice(1);
        } else {
          filterDiv.classList.add("hidden");
          btn.textContent = target.charAt(0).toUpperCase() + target.slice(1);
        }
      });
    });
  }

  // Toggle sidebars & update button styles
  const leftBtn = document.getElementById("toggleLeftBtn");
  const rightBtn = document.getElementById("toggleRightBtn");
  const sidebarLeft = document.getElementById("sidebar-left");
  const sidebarRight = document.getElementById("sidebar-right");

  leftBtn.addEventListener("click", function () {
    if (sidebarLeft.style.display === "none") {
      sidebarLeft.style.display = "block";
      this.classList.remove("active");
    } else {
      sidebarLeft.style.display = "none";
      this.classList.add("active");
    }
  });

  rightBtn.addEventListener("click", function () {
    if (sidebarRight.style.display === "none") {
      sidebarRight.style.display = "block";
      this.classList.remove("active");
    } else {
      sidebarRight.style.display = "none";
      this.classList.add("active");
    }
  });

  function filterMap() {
    if (!geojsonLayer) return;
    geojsonLayer.eachLayer((layer) => {
      const cp =
        layer.feature.properties.code_postal ||
        layer.feature.properties.codePostal ||
        layer.feature.properties.code ||
        "";
      const props = extraProperties[cp];

      if (!props) {
        if (layer._map) layer.remove();
        return;
      }

      const valAgence = getFieldValueCI(props, "agence");
      const valRegion = getFieldValueCI(props, "region");
      const valAntenne = getFieldValueCI(props, "antenne");
      const valDSP = getFieldValueCI(props, "dsp");
      const valDepartement = getFieldValueCI(props, "departement");
      const valTexte2 = getFieldValueCI(props, "texte2");

      let visible =
        filterState.agence.get(valAgence) !== false &&
        filterState.region.get(valRegion) !== false &&
        filterState.antenne.get(valAntenne) !== false &&
        filterState.dsp.get(valDSP) !== false &&
        filterState.departement.get(valDepartement) !== false &&
        filterState.texte2.get(valTexte2) !== false;

      if (visible) {
        if (!layer._map) layer.addTo(map);
      } else {
        if (layer._map) layer.remove();
      }
    });
  }

  document.getElementById("convertBtn").addEventListener("click", () => {
    const fileInput = document.getElementById("uploadExcel");
    if (fileInput.files.length === 0) {
      alert("Veuillez sélectionner un fichier Excel");
      return;
    }

    const reader = new FileReader();
    reader.onload = (e) => {
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, { type: "array" });
      const sheetName = workbook.SheetNames[0];
      const sheet = workbook.Sheets[sheetName];
      const json = XLSX.utils.sheet_to_json(sheet);

      extraProperties = {};

      // Initialize Distinct objects again:
      distinctFields.forEach((field) => {
        distinctValues[field] = new Map();
        filterState[field] = new Map();
      });

      json.forEach((item) => {
        const cp = (item["Code Postal"] || "").toString();
        if (!cp) return;

        // Store full row
        extraProperties[cp] = item;

        distinctFields.forEach((field) => {
          const val = getFieldValueCI(item, field);
          if (val) {
            if (!distinctValues[field].has(val)) distinctValues[field].set(val, new Set());
            distinctValues[field].get(val).add(cp);
          }
        });
      });

      // Build all filters and setup
      populateFilters();
      setupFilterToggles();

      map.setView([46.6, 2.4], 6);

      // Load GeoJSON and draw polygons
      fetch("contours.geojson")
        .then((res) => {
          if (!res.ok) throw new Error("Erreur chargement GeoJSON");
          return res.json();
        })
        .then((geojson) => {
          if (geojsonLayer) geojsonLayer.remove();

          geojsonLayer = L.geoJSON(geojson, {
            style: (feature) => {
              const cp =
                feature.properties.code_postal ||
                feature.properties.codePostal ||
                feature.properties.code ||
                "";
              const p = extraProperties[cp] || {};
              return {
                fillColor: p.DSP_Couleur || "#6688CC",
                color: p.Ligne_Couleur || "#000000",
                weight: 1,
                opacity: 1,
                fillOpacity: 0.7,
              };
            },
            onEachFeature: (feature, layer) => {
              const cp =
                feature.properties.code_postal ||
                feature.properties.codePostal ||
                feature.properties.code ||
                "";
              const p = extraProperties[cp];
              if (!p) return;
              const tooltipText = [p.Texte1, p.Texte2, p.Texte3, p.Texte4]
                .filter(Boolean)
                .join(" ");
              const color = p["Police couleur"] || "#000000";
              layer.bindTooltip(
                `<span style="color: ${color}">${tooltipText}</span>`
              );
              if (p.Clic_URL) {
                layer.on("click", () => window.open(p.Clic_URL, "_blank"));
                layer.setStyle({ cursor: "pointer" });
              }
            },
          }).addTo(map);

          filterMap();
        })
        .catch((e) => {
          alert(e.message);
          console.error(e);
          map.setView([46.6, 2.4], 6);
        });

      alert("Conversion et affichage réalisés !");
    };

    reader.readAsArrayBuffer(fileInput.files[0]);
  });
</script>

</body>
</html>
