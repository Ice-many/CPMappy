<!DOCTYPE html>
<html>
<head>
  <title>Carte interactive codes postaux France</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    html, body {margin:0; padding:0; height:100%; font-family:Arial,sans-serif; overflow:hidden;}
    body {display:flex; height:100vh; user-select:none;}
    #sidebar-left,#sidebar-right{background:#000;color:white;overflow-y:auto;padding:10px;box-shadow:2px 0 5px rgba(0,0,0,0.3);font-size:14px;min-width:180px;max-width:400px;resize:horizontal;}
    #sidebar-left{border-right:1px solid #444;width:250px;}
    #sidebar-right{border-left:1px solid #444;width:250px;}
    #map{flex-grow:1; height:100vh;}
    label{display:block;margin-bottom:6px;cursor:pointer;user-select:text;color:white;}
    #controls{padding:10px;background:#111;position:sticky;top:0;z-index:1000;border-bottom:1px solid #444;margin-bottom:10px;user-select:none;color:white;}
    .custom-tooltip{font-weight:bold;}
    .selectall-label{font-weight:bold;margin-top:6px;border-bottom:1px solid #444;padding-bottom:2px;cursor:pointer;user-select:none;color:white;}
    .toggle-btn{font-size:14px;background:#007bff;border:none;color:white;padding:4px 10px;border-radius:4px;cursor:pointer;user-select:none;margin:10px 0 6px 0;width:100%;text-align:left;}
    #toggleLeftBtn,#toggleRightBtn{position:fixed;top:10px;padding:8px 14px;font-size:14px;border-radius:4px;cursor:pointer;z-index:1300;user-select:none;box-shadow:0 2px 8px rgba(106,13,173,0.7);color:white;background-color:#6a0dad;}
    #toggleLeftBtn{left:10px;}
    #toggleRightBtn{right:10px;}
    .hidden{display:none !important;}
    input[disabled]{filter:grayscale(1) brightness(1.4);}
  </style>
</head>
<body>
<button id="toggleLeftBtn" title="Afficher/Masquer Réseau">Réseau</button>
<button id="toggleRightBtn" title="Afficher/Masquer Département">Département</button>
<div id="sidebar-left">
  <div id="controls">
    <input type="file" id="uploadExcel" accept=".xlsx" />
    <button id="convertBtn">Conversion JSON et Affichage</button>
  </div>
  <button class="toggle-btn" data-target="agence">Agence</button>
  <div id="filter-agence" class="hidden">
    <label class="selectall-label"><input type="checkbox" id="agence-select-all" checked> Tout Agences</label>
    <div id="agenceList"></div>
  </div>
  <button class="toggle-btn" data-target="region">Région</button>
  <div id="filter-region" class="hidden">
    <label class="selectall-label"><input type="checkbox" id="region-select-all" checked> Tout Régions</label>
    <div id="regionList"></div>
  </div>
  <button class="toggle-btn" data-target="antenne">Antenne</button>
  <div id="filter-antenne" class="hidden">
    <label class="selectall-label"><input type="checkbox" id="antenne-select-all" checked> Tout Antennes</label>
    <div id="antenneList"></div>
  </div>
  <button class="toggle-btn" data-target="dsp">DSP</button>
  <div id="filter-dsp" class="hidden">
    <label class="selectall-label"><input type="checkbox" id="dsp-select-all" checked> Tout DSP</label>
    <div id="dspList"></div>
  </div>
  <button class="toggle-btn" data-target="canaldis">Canal DIS</button>
  <div id="filter-canaldis" class="hidden">
    <label class="selectall-label"><input type="checkbox" id="canaldis-select-all" checked> Tout Canal DIS</label>
    <div id="canaldisList"></div>
  </div>
</div>
<div id="map"></div>
<div id="sidebar-right">
  <button class="toggle-btn" data-target="departement">Département</button>
  <div id="filter-departement" class="hidden">
    <label class="selectall-label"><input type="checkbox" id="departement-select-all" checked> Tout Départements</label>
    <div id="departementList"></div>
  </div>
  <button class="toggle-btn" data-target="texte2">Texte2</button>
  <div id="filter-texte2" class="hidden">
    <label class="selectall-label"><input type="checkbox" id="texte2-select-all" checked> Tout Texte2</label>
    <div id="texte2List"></div>
  </div>
</div>
<script>
var map = L.map('map', { minZoom: 6, center: [46.6, 2.4], zoom: 6 });
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 18, attribution: '© OpenStreetMap contributors'
}).addTo(map);
let extraProperties = {}, geoLayer;
let distinctValues = {
  agence: new Map(), region: new Map(), antenne: new Map(), departement: new Map(), texte2: new Map(), dsp: new Map(), canaldis: new Map()
};
let filterState = {
  agence:new Map(), region:new Map(), antenne:new Map(), departement:new Map(), texte2:new Map(), dsp:new Map(), canaldis:new Map()
};
function getKeyIgnoreCase(obj, key) {
  key = key.toLowerCase().replace(/\s+/g, '');
  for (const k in obj) {
    if (k.toLowerCase().replace(/\s+/g, '') === key) return obj[k];
  }
  return null;
}
function getFilteredCPs() {
  let res = [];
  for(const cp in extraProperties) {
    const ex = extraProperties[cp];
    if(!ex) continue;
    if (
      filterState.agence.get(getKeyIgnoreCase(ex, "Agence")||"") !== false &&
      filterState.region.get(getKeyIgnoreCase(ex, "région")||"") !== false &&
      filterState.antenne.get(getKeyIgnoreCase(ex, "Antenne")||"") !== false &&
      filterState.departement.get(getKeyIgnoreCase(ex, "Departement")||"") !== false &&
      filterState.texte2.get(getKeyIgnoreCase(ex, "Texte2")||"") !== false &&
      filterState.dsp.get(getKeyIgnoreCase(ex, "DSP")||"") !== false &&
      filterState.canaldis.get(getKeyIgnoreCase(ex, "Canal DIS")||"") !== false
    ) res.push(cp);
  }
  return res;
}
function updateDynamicFilterLists() {
  const filters = ['agence','region','antenne','departement','texte2','dsp','canaldis'];
  let validCPs = getFilteredCPs();
  let compatible = {};
  filters.forEach(f=>compatible[f]=new Set());
  validCPs.forEach(cp=>{
    const ex = extraProperties[cp];
    filters.forEach(f=>{
      compatible[f].add(getKeyIgnoreCase(ex,f.charAt(0).toUpperCase()+f.slice(1))||"");
    });
  });
  filters.forEach(f=>{
    const listDiv=document.getElementById(f+'List');
    if(!listDiv) return;
    listDiv.innerHTML='';
    Array.from(distinctValues[f].keys()).sort().forEach(val=>{
      const label=document.createElement('label');
      label.title=`${distinctValues[f].get(val).size} codes postaux`;
      const cbox=document.createElement('input');
      cbox.type='checkbox';
      cbox.checked = filterState[f].get(val)!==false; 
      cbox.disabled = !compatible[f].has(val);
      cbox.addEventListener('change',()=>{
        filterState[f].set(val,cbox.checked);
        updateDynamicFilterLists(); filterGeoLayer();
      });
      label.appendChild(cbox);
      label.appendChild(document.createTextNode(' '+val));
      listDiv.appendChild(label);
    });
    updateSelectAllCheckbox(f);
  });
}
function updateSelectAllCheckbox(filterName) {
  const selectAllCheckbox=document.getElementById(filterName + '-select-all');
  if(!selectAllCheckbox) return;
  const cbs=document.getElementById(filterName+'List').querySelectorAll('input[type="checkbox"]:not([disabled])');
  let allChecked=Array.from(cbs).length>0 && Array.from(cbs).every(cb=>cb.checked);
  let someChecked=Array.from(cbs).some(cb=>cb.checked);
  selectAllCheckbox.checked=allChecked;
  selectAllCheckbox.indeterminate=someChecked && !allChecked;
}
function setupSelectAllListener(filterName) {
  const selectAllCheckbox=document.getElementById(filterName + '-select-all');
  if(!selectAllCheckbox) return;
  selectAllCheckbox.addEventListener('change',()=>{
    const checked = selectAllCheckbox.checked;
    const container = document.getElementById(filterName+'List');
    Array.from(container.querySelectorAll('input[type="checkbox"]:not([disabled])')).forEach(cb=>{
      cb.checked=checked;
      const val=cb.nextSibling.textContent.trim();
      filterState[filterName].set(val,checked);
    });
    updateDynamicFilterLists();
    filterGeoLayer();
  });
}
function setupFilterToggleButtons() {
  const buttons=document.querySelectorAll('.toggle-btn');
  buttons.forEach(btn=>{
    const targetId=btn.getAttribute('data-target');
    btn.textContent=capitalizeFirstLetter(targetId);
    btn.addEventListener('click',()=>{
      const el=document.getElementById('filter-'+targetId);
      if(!el)return;
      if(el.classList.contains('hidden')){
        el.classList.remove('hidden');
        btn.textContent='Masquer '+capitalizeFirstLetter(targetId);
      }else{
        el.classList.add('hidden');
        btn.textContent=capitalizeFirstLetter(targetId);
      }
    });
  });
}
function capitalizeFirstLetter(str) {
  return str.charAt(0).toUpperCase() + str.slice(1);
}
document.getElementById('toggleLeftBtn').addEventListener('click',()=>{
  const left=document.getElementById('sidebar-left');
  left.style.display=(left.style.display==='none')?'block':'none';
});
document.getElementById('toggleRightBtn').addEventListener('click',()=>{
  const right=document.getElementById('sidebar-right');
  right.style.display=(right.style.display==='none')?'block':'none';
});
function updateDistinctValues(jsonData) {
  for (const key in distinctValues) {distinctValues[key].clear(); filterState[key].clear();}
  jsonData.forEach(item=>{
    const cp=(item["Code Postal"]||"").toString(); if(!cp)return;
    const ag=getKeyIgnoreCase(item,"Agence")||""; const re=getKeyIgnoreCase(item,"région")||""; const an=getKeyIgnoreCase(item,"Antenne")||""; const dep=getKeyIgnoreCase(item,"Departement")||""; const tx2=getKeyIgnoreCase(item,"Texte2")||""; const dsp=getKeyIgnoreCase(item,"DSP")||""; const canaldis=getKeyIgnoreCase(item,"Canal DIS")||"";
    if(!distinctValues.agence.has(ag))distinctValues.agence.set(ag,new Set());distinctValues.agence.get(ag).add(cp);
    if(!distinctValues.region.has(re))distinctValues.region.set(re,new Set());distinctValues.region.get(re).add(cp);
    if(!distinctValues.antenne.has(an))distinctValues.antenne.set(an,new Set());distinctValues.antenne.get(an).add(cp);
    if(!distinctValues.departement.has(dep))distinctValues.departement.set(dep,new Set());distinctValues.departement.get(dep).add(cp);
    if(!distinctValues.texte2.has(tx2))distinctValues.texte2.set(tx2,new Set());distinctValues.texte2.get(tx2).add(cp);
    if(!distinctValues.dsp.has(dsp))distinctValues.dsp.set(dsp, new Set());distinctValues.dsp.get(dsp).add(cp);
    if(!distinctValues.canaldis.has(canaldis))distinctValues.canaldis.set(canaldis, new Set());distinctValues.canaldis.get(canaldis).add(cp);
  });
}
function buildFilterLists() {
  const filters=['agence','region','antenne','departement','texte2','dsp','canaldis'];
  filters.forEach(filter=>{
    const listDiv=document.getElementById(filter+'List');
    listDiv.innerHTML='';
    Array.from(distinctValues[filter].keys()).sort().forEach(val=>{
      const label=document.createElement('label');label.title=`${distinctValues[filter].get(val).size} codes postaux`;const cbox=document.createElement('input');cbox.type='checkbox';cbox.checked=true;filterState[filter].set(val,true);
      cbox.addEventListener('change',()=>{
        filterState[filter].set(val, cbox.checked);
        updateDynamicFilterLists(); filterGeoLayer();
      });
      label.appendChild(cbox); label.appendChild(document.createTextNode(' '+val)); listDiv.appendChild(label);
    });
    updateSelectAllCheckbox(filter);setupSelectAllListener(filter);
  });
  setupFilterToggleButtons();
}
function filterGeoLayer() {
  if (!geoLayer) return;
  let validCPs = getFilteredCPs();
  geoLayer.eachLayer(layer=>{
    let cp=layer.feature.properties.code_postal||layer.feature.properties.codePostal||layer.feature.properties.code||"";
    if(validCPs.includes(cp)){layer.addTo(map);} else {map.removeLayer(layer);}
  });
}
document.getElementById('convertBtn').onclick=()=>{
  const fileInput=document.getElementById('uploadExcel');
  const file=fileInput.files[0];
  if(!file){alert("Sélectionnez un fichier Excel (.xlsx) à convertir avant de cliquer.");return;}
  const reader=new FileReader();
  reader.onload=e=>{
    const data=new Uint8Array(e.target.result);
    const workbook=XLSX.read(data,{type:'array'});
    const firstSheetName=workbook.SheetNames[0];
    const sheet=workbook.Sheets[firstSheetName];
    const jsonData=XLSX.utils.sheet_to_json(sheet);
    extraProperties={}; updateDistinctValues(jsonData);
    jsonData.forEach(item=>{const cp=(item["Code Postal"]||"").toString();if(cp.length>0)extraProperties[cp]=item;});
    buildFilterLists();
    map.setView([46.6,2.4],6);
    updateMapWithExtraProperties();
    setTimeout(()=>alert("Conversion et affichage réalisés !"),200);
  };
  reader.readAsArrayBuffer(file);
};
function updateMapWithExtraProperties() {
  fetch('contours-codes-postaux.geojson')
  .then(res => {if(!res.ok)throw new Error("Le fichier GeoJSON n'a pas été chargé correctement.");return res.json();})
  .then(data => {
    if(geoLayer)map.removeLayer(geoLayer);
    geoLayer=L.geoJSON(data,{style:function(feature){
      let cp=feature.properties.code_postal||feature.properties.codePostal||feature.properties.code||"";
      let extras=extraProperties[cp]||{};
      return{fillColor:getKeyIgnoreCase(extras,"Fond_couleur")||"#66cc66",color:getKeyIgnoreCase(extras,"Ligne_couleur")||"#000000",weight:1,opacity:1,fillOpacity:0.7};
    },onEachFeature:function(feature,layer){
      let cp=feature.properties.code_postal||feature.properties.codePostal||feature.properties.code||"";
      let extras=extraProperties[cp]||{};let texteParts=[];
      ["Texte1","Texte2","Texte3","Texte4"].forEach(field=>{let val=getKeyIgnoreCase(extras,field);if(val)texteParts.push(val);});
      let tooltipText=texteParts.join(" ");let policeCouleur=getKeyIgnoreCase(extras,"police couleur")||'#000000';
      layer.bindTooltip(`<span style="color: ${policeCouleur};">${tooltipText||("Code Postal : "+cp)}</span>`,{className: 'custom-tooltip'});
      let clicUrl=getKeyIgnoreCase(extras,"Clic URL");
      if(clicUrl&&clicUrl.trim().length>0){layer.on("click",()=>window.open(clicUrl,'_blank'));layer.setStyle({cursor:"pointer"});}
    }}).addTo(map);
    updateDynamicFilterLists(); filterGeoLayer();
  })
  .catch(err=>{alert(err.message);console.error(err);map.setView([46.6,2.4],6);});
}
</script>
</body>
</html>
