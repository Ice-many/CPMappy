<script>
var map = L.map('map',{minZoom:6,center:[46.6,2.4],zoom:6});
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:18,attribution:'Â© OpenStreetMap contributors'}).addTo(map);

let extraProperties={}, geoLayer;
let distinctValues={region:new Map(), agence:new Map(), antenne:new Map(), dsp:new Map(), canaldis:new Map(), departement:new Map(), texte2:new Map()};
let filterState={region:new Map(), agence:new Map(), antenne:new Map(), dsp:new Map(), canaldis:new Map(), departement:new Map(), texte2:new Map()};
let contourVisible=true;

function normalizeKey(key){
  return key.toString().toLowerCase().replace(/\s+/g,'').replace(/[Ã©Ã¨Ãª]/g,'e').replace(/[Ã Ã¢]/g,'a');
}

function normalizeObject(obj){
  let n={};
  for(const k in obj){ n[normalizeKey(k)] = obj[k]; }
  return n;
}

// Fonction utilitaire
function getKey(obj, key){
  return obj[normalizeKey(key)] || null;
}

document.getElementById('uploadExcel').addEventListener('change',()=>{
  const file=document.getElementById('uploadExcel').files[0];
  if(!file) return;
  document.getElementById('loadingOverlay').classList.remove('hidden');
  const reader=new FileReader();
  reader.onload=e=>{
    try {
      const data=new Uint8Array(e.target.result);
      const workbook=XLSX.read(data,{type:'array'});
      const sheet=workbook.Sheets[workbook.SheetNames[0]];
      let jsonData=XLSX.utils.sheet_to_json(sheet);

      // ðŸ”¥ Normaliser les clÃ©s
      jsonData=jsonData.map(row=>normalizeObject(row));

      extraProperties={}; 
      Object.keys(distinctValues).forEach(k=>{ distinctValues[k].clear(); filterState[k].clear(); });

      jsonData.forEach(item=>{
        const cp=(item["codepostal"]||item["code_postal"]||"").toString();
        if(cp){
          extraProperties[cp]=item;
          // remplir distinctValues
          Object.keys(distinctValues).forEach(f=>{
            const val=item[normalizeKey(f)];
            if(val){ distinctValues[f].set(val,true); filterState[f].set(val,true); }
          });
        }
      });

      buildFilterLists(); 
      map.setView([46.6,2.4],6);

      updateMapWithExtraProperties().finally(()=>{
        document.getElementById('loadingOverlay').classList.add('hidden');
      });

    } catch(err) {
      console.error("Erreur Excel:",err);
      document.getElementById('loadingOverlay').classList.add('hidden');
    }
  };
  reader.readAsArrayBuffer(file);
});

function updateMapWithExtraProperties(){
  return fetch('contours-codes-postaux.geojson')
  .then(res=>res.json())
  .then(data=>{
    if(geoLayer) map.removeLayer(geoLayer);
    geoLayer=L.geoJSON(data,{
      style:function(feature){
        const cp=feature.properties.code_postal||feature.properties.codePostal||feature.properties.code||"";
        const extras=extraProperties[cp]||{};
        return { fillColor:getKey(extras,"fondcouleur")||"#66cc66",
                 color:getKey(extras,"lignecouleur")||"#000000",
                 weight: contourVisible?1:0, opacity:1, fillOpacity:0.7 };
      },
      onEachFeature:function(feature,layer){
        const cp=feature.properties.code_postal||feature.properties.codePostal||feature.properties.code||"";
        const extras=extraProperties[cp]||{};
        let texteParts=[]; ["texte1","texte2","texte3","texte4"].forEach(fld=>{ const val=getKey(extras,fld); if(val) texteParts.push(val); });
        const tooltipText=texteParts.join(" ");
        const policeCouleur=getKey(extras,"policecouleur")||'#000000';
        layer.bindTooltip(`<span style="color:${policeCouleur};">${tooltipText||("Code Postal : "+cp)}</span>`,{className:'custom-tooltip'});
        const clicUrl=getKey(extras,"clicurl");
        if(clicUrl && clicUrl.trim().length>0){ layer.on("click",()=>window.open(clicUrl,'_blank')); layer.setStyle({ cursor:"pointer" }); }
      }
    }).addTo(map);
    filterGeoLayer();
  })
  .catch(err=>{
    console.error("Erreur GeoJSON:",err);
  });
}
</script>
