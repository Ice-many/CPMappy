<!DOCTYPE html>
<html>
<head>
  <title>Carte interactive filtres DSP intégrée</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    html, body {
      margin: 0; padding: 0; height: 100%;
      font-family: Arial, sans-serif;
      overflow: hidden;
    }
    body {
      display: flex;
      height: 100vh;
      user-select: none;
    }
    #sidebar-left, #sidebar-right {
      background: #000;
      color: white;
      overflow-y: auto;
      padding: 10px;
      box-shadow: 2px 0 5px rgba(0,0,0,0.3);
      font-size: 14px;
      min-width: 180px;
      max-width: 400px;
      resize: horizontal;
      overflow: auto;
    }
    #sidebar-left {
      border-right: 1px solid #444;
      width: 250px;
    }
    #sidebar-right {
      border-left: 1px solid #444;
      width: 250px;
    }
    #map {
      flex-grow: 1;
      height: 100vh;
    }
    label {
      display: block;
      margin-bottom: 6px;
      cursor: pointer;
      user-select: text;
      color: white;
    }
    #controls {
      padding: 10px;
      background: #111;
      position: sticky;
      top: 0;
      z-index: 1000;
      border-bottom: 1px solid #444;
      margin-bottom: 10px;
      user-select: none;
      color: white;
    }
    .custom-tooltip {
      font-weight: bold;
    }
    .selectall-label {
      font-weight: bold;
      margin-top: 6px;
      border-bottom: 1px solid #444;
      padding-bottom: 2px;
      cursor: pointer;
      user-select: none;
      color: white;
    }
    .toggle-btn {
      font-size: 14px;
      background: #007bff;
      border: none;
      color: white;
      padding: 4px 10px;
      border-radius: 4px;
      cursor: pointer;
      user-select: none;
      margin: 10px 0 6px 0;
      width: 100%;
      text-align: left;
    }
    #toggleLeftBtn, #toggleRightBtn {
      position: fixed;
      top: 10px;
      padding: 8px 14px;
      font-size: 14px;
      border-radius: 4px;
      cursor: pointer;
      z-index: 1300;
      user-select: none;
      box-shadow: 0 2px 8px rgba(106,13,173,0.7);
      color: white;
      background-color: #6a0dad;
      transition: background-color 0.3s ease;
    }
    #toggleLeftBtn.active, #toggleRightBtn.active {
      background-color: #00bfff;
      box-shadow: 0 2px 8px rgba(0,191,255,0.7);
    }
    #toggleLeftBtn { left: 10px; }
    #toggleRightBtn { right: 10px; }
    .hidden { display: none !important; }
  </style>
</head>
<body>

  <!-- Buttons to toggle sidebars -->
  <button id="toggleLeftBtn" title="Afficher/Masquer Réseau">Réseau</button>
  <button id="toggleRightBtn" title="Afficher/Masquer Département">Département</button>

  <div id="sidebar-left">
    <div id="controls">
      <input type="file" id="uploadExcel" accept=".xlsx" />
      <button id="convertBtn">Conversion et Affichage</button>
    </div>

    <!-- Filters in sidebar left -->
    <button class="toggle-btn" data-target="agence">Agence</button>
    <div id="filter-agence" class="hidden">
      <label class="selectall-label">
        <input type="checkbox" id="agence-select-all" /> Tout Agences
      </label>
      <div id="agenceList"></div>
    </div>

    <button class="toggle-btn" data-target="region">Région</button>
    <div id="filter-region" class="hidden">
      <label class="selectall-label">
        <input type="checkbox" id="region-select-all" /> Tout Régions
      </label>
      <div id="regionList"></div>
    </div>

    <button class="toggle-btn" data-target="antenne">Antenne</button>
    <div id="filter-antenne" class="hidden">
      <label class="selectall-label">
        <input type="checkbox" id="antenne-select-all" /> Tout Antennes
      </label>
      <div id="antenneList"></div>
    </div>

    <!-- Added DSP filter -->
    <button class="toggle-btn" data-target="dsp">DSP</button>
    <div id="filter-dsp" class="hidden">
      <label class="selectall-label">
        <input type="checkbox" id="dsp-select-all" /> Tout DSP
      </label>
      <div id="dspList"></div>
    </div>
  </div>

  <div id="map"></div>

  <div id="sidebar-right">
    <!-- Filters in sidebar right -->
    <button class="toggle-btn" data-target="departement">Département</button>
    <div id="filter-departement" class="hidden">
      <label class="selectall-label">
        <input type="checkbox" id="departement-select-all" /> Tout Départements
      </label>
      <div id="departementList"></div>
    </div>

    <button class="toggle-btn" data-target="texte2">Texte2</button>
    <div id="filter-texte2" class="hidden">
      <label class="selectall-label">
        <input type="checkbox" id="texte2-select-all" /> Tout Texte2
      </label>
      <div id="texte2List"></div>
    </div>
  </div>

  <script>
    // Initialize map
    var map = L.map('map', { minZoom: 6, center: [46.5, 2.5], zoom: 6 });

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18,
      attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    // Data containers
    let extraProperties = {};
    let geoLayer;

    // Filter distinct values
    let distinctValues = {
      agence: new Map(),
      region: new Map(),
      antenne: new Map(),
      dsp: new Map(),      // added DSP
      departement: new Map(),
      texte2: new Map()
    };

    // Current filter state
    let filterState = {
      agence: new Map(),
      region: new Map(),
      antenne: new Map(),
      dsp: new Map(),      // added DSP
      departement: new Map(),
      texte2: new Map()
    };

    // Case-insensitive key retrieval
    function getValueCI(obj, key) {
      if (!obj) return "";
      key = key.toLowerCase().replace(/\s+/g, '');
      for (const k in obj) {
        if (k.toLowerCase().replace(/\s+/g, '') === key) return obj[k];
      }
      return "";
    }

    // Build the filter list in the DOM
    function buildFilterList(filterName, containerId) {
      const container = document.getElementById(containerId);
      container.innerHTML = "";
      const valsMap = distinctValues[filterName];
      if (!valsMap) return;
      let vals = Array.from(valsMap.keys());
      vals.sort((a,b) => a.localeCompare(b, undefined, {ignorePunctuation: true}));
      vals.forEach(val => {
        const setCP = valsMap.get(val);
        const label = document.createElement("label");
        label.title = `${setCP.size} codes postaux`;
        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.checked = true;
        filterState[filterName].set(val, true);
        checkbox.addEventListener("change", () => {
          filterState[filterName].set(val, checkbox.checked);
          updateSelectAllCheckbox(filterName);
          filterMap();
        });
        label.appendChild(checkbox);
        label.appendChild(document.createTextNode(" " + val));
        container.appendChild(label);
      });
    }

    // Update 'select all' checkbox state
    function updateSelectAllCheckbox(filterName) {
      const sel = document.getElementById(filterName + "-select-all");
      if (!sel) return;
      const values = Array.from(filterState[filterName].values());
      const allChecked = values.length > 0 && values.every(v => v === true);
      sel.checked = allChecked;
      sel.indeterminate = !allChecked && values.some(v => v === true);
    }

    // Setup 'select all' checkbox
    function setupSelectAllCheckbox(filterName) {
      const sel = document.getElementById(filterName + "-select-all");
      if (!sel) return;
      sel.addEventListener("change", () => {
        const checked = sel.checked;
        filterState[filterName].forEach((_, key) => filterState[filterName].set(key, checked));
        const container = document.getElementById(filterName + "List");
        if (container) {
          container.querySelectorAll("input[type=checkbox]").forEach(cb => (cb.checked = checked));
        }
        filterMap();
      });
    }

    // Toggle visibility on filter buttons
    function setupFilterToggles() {
      document.querySelectorAll(".toggle-btn").forEach(btn => {
        const target = btn.getAttribute("data-target");
        btn.textContent = target.charAt(0).toUpperCase() + target.slice(1);
        btn.addEventListener("click", () => {
          const filterDiv = document.getElementById("filter-" + target);
          if (!filterDiv) return;
          if (filterDiv.classList.contains("hidden")) {
            filterDiv.classList.remove("hidden");
            btn.textContent = "Masquer " + target.charAt(0).toUpperCase() + target.slice(1);
          } else {
            filterDiv.classList.add("hidden");
            btn.textContent = target.charAt(0).toUpperCase() + target.slice(1);
          }
        });
      });
    }

    // Toggle sidebars visibility with button click & color switch
    document.getElementById("toggleLeftBtn").addEventListener("click", function () {
      const sidebar = document.getElementById("sidebar-left");
      const btn = this;
      if (sidebar.style.display === "none") {
        sidebar.style.display = "block";
        btn.classList.remove("active");
        btn.style.backgroundColor = "#6a0dad";
        btn.style.boxShadow = "0 2px 8px rgba(106,13,173,0.7)";
      } else {
        sidebar.style.display = "none";
        btn.classList.add("active");
        btn.style.backgroundColor = "#00bfff";
        btn.style.boxShadow = "0 2px 8px rgba(0,191,255,0.7)";
      }
    });

    document.getElementById("toggleRightBtn").addEventListener("click", function () {
      const sidebar = document.getElementById("sidebar-right");
      const btn = this;
      if (sidebar.style.display === "none") {
        sidebar.style.display = "block";
        btn.classList.remove("active");
        btn.style.backgroundColor = "#6a0dad";
        btn.style.boxShadow = "0 2px 8px rgba(106,13,173,0.7)";
      } else {
        sidebar.style.display = "none";
        btn.classList.add("active");
        btn.style.backgroundColor = "#00bfff";
        btn.style.boxShadow = "0 2px 8px rgba(0,191,255,0.7)";
      }
    });

    // Filtering logic
    function filterMap() {
      if (!geoLayer) return;
      geoLayer.eachLayer(layer => {
        const cp = layer.feature.properties.code_postal || layer.feature.properties.postal_code || layer.feature.properties.code || "";
        const extras = extraProperties[cp];
        if (!extras) {
          if (layer._map) layer.remove();
          return;
        }
        const valAg = getValueCI(extras, "Agence");
        const valRg = getValueCI(extras, "région");
        const valAn = getValueCI(extras, "Antenne");
        const valDsp = getValueCI(extras, "DSP");
        const valDep = getValueCI(extras, "Departement");
        const valT2 = getValueCI(extras, "Texte2");

        const visible =
          (filterState.agence.get(valAg) !== false) &&
          (filterState.region.get(valRg) !== false) &&
          (filterState.antenne.get(valAn) !== false) &&
          (filterState.dsp.get(valDsp) !== false) &&
          (filterState.departement.get(valDep) !== false) &&
          (filterState.texte2.get(valT2) !== false);

        if (visible) {
          if (!layer._map) layer.addTo(map);
        } else {
          if (layer._map) layer.remove();
        }
      });
    }

    // Update distinct filters from data
    function updateDistinctFilters(data) {
      Object.keys(distinctValues).forEach(k => {
        distinctValues[k].clear();
        filterState[k].clear();
      });

      data.forEach(item => {
        const cp = (item["Code Postal"] || "").toString();
        if (!cp) return;
        const ag = getValueCI(item, "Agence");
        const rg = getValueCI(item, "région");
        const an = getValueCI(item, "Antenne");
        const dsp = getValueCI(item, "DSP");
        const dep = getValueCI(item, "Departement");
        const t2 = getValueCI(item, "Texte2");

        if (ag && !distinctValues.agence.has(ag)) distinctValues.agence.set(ag, new Set());
        distinctValues.agence.get(ag).add(cp);

        if (rg && !distinctValues.region.has(rg)) distinctValues.region.set(rg, new Set());
        distinctValues.region.get(rg).add(cp);

        if (an && !distinctValues.antenne.has(an)) distinctValues.antenne.set(an, new Set());
        distinctValues.antenne.get(an).add(cp);

        if (dsp && !distinctValues.dsp.has(dsp)) distinctValues.dsp.set(dsp, new Set());
        distinctValues.dsp.get(dsp).add(cp);

        if (dep && !distinctValues.departement.has(dep)) distinctValues.departement.set(dep, new Set());
        distinctValues.departement.get(dep).add(cp);

        if (t2 && !distinctValues.texte2.has(t2)) distinctValues.texte2.set(t2, new Set());
        distinctValues.texte2.get(t2).add(cp);
      });
    }

    // Populate filter lists in DOM
    function populateFilters() {
      ["agence", "region", "antenne", "dsp", "departement", "texte2"].forEach(f => {
        buildFilterList(f, f + "List");
        updateSelectAllCheckbox(f);
        setupSelectAllCheckbox(f);
      });
    }

    document.getElementById("toggleLeftBtn").addEventListener("click", function() {
      const sidebar = document.getElementById("sidebar-left");
      const btn = this;
      if (sidebar.style.display === "none") {
        sidebar.style.display = "block";
        btn.classList.remove("active");
        btn.style.backgroundColor = "#6a0dad";
        btn.style.boxShadow = "0 2px 8px rgba(106,13,173,0.7)";
      } else {
        sidebar.style.display = "none";
        btn.classList.add("active");
        btn.style.backgroundColor = "#00bfff";
        btn.style.boxShadow = "0 2px 8px rgba(0,191,255,0.7)";
      }
      filterMap();
    });

    document.getElementById("toggleRightBtn").addEventListener("click", function() {
      const sidebar = document.getElementById("sidebar-right");
      const btn = this;
      if (sidebar.style.display === "none") {
        sidebar.style.display = "block";
        btn.classList.remove("active");
        btn.style.backgroundColor = "#6a0dad";
        btn.style.boxShadow = "0 2px 8px rgba(106,13,173,0.7)";
      } else {
        sidebar.style.display = "none";
        btn.classList.add("active");
        btn.style.backgroundColor = "#00bfff";
        btn.style.boxShadow = "0 2px 8px rgba(0,191,255,0.7)";
      }
      filterMap();
    });

    function setupToggleButtons() {
      const buttons = document.querySelectorAll(".toggle-btn");
      buttons.forEach(btn => {
        const target = btn.getAttribute("data-target");
        btn.textContent = target.charAt(0).toUpperCase() + target.slice(1);
        btn.addEventListener("click", () => {
          const filterDiv = document.getElementById("filter-" + target);
          if (!filterDiv) return;
          if (filterDiv.classList.contains("hidden")) {
            filterDiv.classList.remove("hidden");
            btn.textContent = "Masquer " + target.charAt(0).toUpperCase() + target.slice(1);
          } else {
            filterDiv.classList.add("hidden");
            btn.textContent = target.charAt(0).toUpperCase() + target.slice(1);
          }
        });
      });
    }

    // File converter & loader button
    document.getElementById("convertBtn").addEventListener("click", function () {
      const input = document.getElementById("uploadExcel");
      if (input.files.length === 0) {
        alert("Veuillez sélectionner un fichier Excel.");
        return;
      }

      const reader = new FileReader();
      reader.onload = function (e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: "array" });
        const firstSheet = workbook.SheetNames[0];
        const sheet = workbook.Sheets[firstSheet];
        const jsonData = XLSX.utils.sheet_to_json(sheet);

        extraProperties = {};
        updateDistinctFilters(jsonData);

        jsonData.forEach(item => {
          const cp = (item["Code Postal"] || "").toString();
          if (!cp) return;
          extraProperties[cp] = item;
        });

        populateFilters();
        setupToggleButtons();

        // Ensure map centered on France
        map.setView([46.5, 2.5], 6);

        fetch("contours.geojson")
          .then(resp => resp.json())
          .then(data => {
            if (geoLayer) geoLayer.remove();
            geoLayer = L.geoJSON(data, {
              style: f => {
                const cp = f.properties.code_postal || f.properties.postal_code || f.properties.code || "";
                const e = extraProperties[cp];
                return {
                  fillColor: e ? e["DSP_Couleur"] || "#6688CC" : "#6688CC",
                  color: e ? e["Ligne_Couleur"] || "#000" : "#000",
                  weight: 1,
                  opacity: 1,
                  fillOpacity: 0.7,
                };
              },
              onEachFeature: (feature, layer) => {
                const cp = feature.properties.code_postal || feature.properties.postal_code || feature.properties.code || "";
                const e = extraProperties[cp];
                if (!e) return;
                const texts = [];
                for (let i = 1; i <= 4; i++) {
                  if (e[`Texte${i}`]) texts.push(e[`Texte${i}`]);
                }
                const textColor = e["Police_Couleur"] || "#000";
                layer.bindTooltip(`<span style="color:${textColor}">${texts.join(" ")}</span>`);
                if (e["Clic_URL"]) {
                  layer.on("click", () => window.open(e["Clic_URL"], "_blank"));
                  layer.setStyle({ cursor: "pointer" });
                }
              },
            }).addTo(map);
            filterMap();
          })
          .catch(e => {
            alert("Impossible de charger le GeoJSON.");
            console.error(e);
          });
        alert("Conversion et affichage réussis !");
      };
      reader.readAsArrayBuffer(input.files[0]);
    });
  </script>
</body>
</html>
