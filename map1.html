<!DOCTYPE html>
<html>
<head>
  <title>Carte interactive codes postaux France</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    html, body { margin:0; padding:0; height:100%; font-family: Arial, sans-serif; overflow:hidden; }
    body { display:flex; height:100vh; user-select:none; }
    #sidebar-left, #sidebar-right {
      background:#000; color:white; overflow-y:auto; padding:10px;
      box-shadow:2px 0 5px rgba(0,0,0,0.3); font-size:14px;
      min-width:180px; max-width:400px; resize:horizontal; overflow:auto;
    }
    #sidebar-left { border-right:1px solid #444; width:250px; }
    #sidebar-right { border-left:1px solid #444; width:250px; }
    #map { flex-grow:1; height:100vh; }
    label { display:block; margin-bottom:6px; cursor:pointer; user-select:text; color:white; }
    label.disabled { color:#777; cursor: default; }
    #controls { padding:10px; background:#111; position:sticky; top:0; z-index:1000; border-bottom:1px solid #444; margin-bottom:10px; color:white; }
    .custom-tooltip { font-weight:bold; }
    .selectall-label { font-weight:bold; margin-top:6px; border-bottom:1px solid #444; padding-bottom:2px; cursor:pointer; }
    .toggle-btn { font-size:14px; background:#007bff; border:none; color:white; padding:4px 10px; border-radius:4px; cursor:pointer; margin:10px 0 6px 0; width:100%; text-align:left; }
    #toggleLeftBtn, #toggleRightBtn { position:fixed; top:10px; padding:8px 14px; font-size:14px; border-radius:4px; cursor:pointer; z-index:1300; box-shadow:0 2px 8px rgba(0,191,255,0.7); color:white; background-color:#00bfff; transition:background-color 0.3s ease; }
    #toggleLeftBtn.violet, #toggleRightBtn.violet { background-color:#6a0dad !important; box-shadow:0 2px 8px rgba(106,13,173,0.7) !important; }
    #toggleLeftBtn { left:10px; } #toggleRightBtn { right:10px; }
    .hidden { display:none !important; }
  </style>
</head>
<body>

<button id="toggleLeftBtn" title="Afficher/Masquer Réseau">Réseau</button>
<button id="toggleRightBtn" title="Afficher/Masquer Département">Département</button>

<div id="sidebar-left">
  <div id="controls">
    <input type="file" id="uploadExcel" accept=".xlsx" />
    <button id="convertBtn">Conversion JSON et Affichage</button>
  </div>

  <button class="toggle-btn" data-target="region">Région</button>
  <div id="filter-region" class="hidden">
    <label class="selectall-label"><input type="checkbox" id="region-select-all" checked> Tout Régions</label>
    <div id="regionList"></div>
  </div>

  <button class="toggle-btn" data-target="agence">Agence</button>
  <div id="filter-agence" class="hidden">
    <label class="selectall-label"><input type="checkbox" id="agence-select-all" checked> Tout Agences</label>
    <div id="agenceList"></div>
  </div>

  <button class="toggle-btn" data-target="antenne">Antenne</button>
  <div id="filter-antenne" class="hidden">
    <label class="selectall-label"><input type="checkbox" id="antenne-select-all" checked> Tout Antennes</label>
    <div id="antenneList"></div>
  </div>

  <button class="toggle-btn" data-target="dsp">DSP</button>
  <div id="filter-dsp" class="hidden">
    <label class="selectall-label"><input type="checkbox" id="dsp-select-all" checked> Tout DSP</label>
    <div id="dspList"></div>
  </div>

  <button class="toggle-btn" data-target="canaldis">Canal DIS</button>
  <div id="filter-canaldis" class="hidden">
    <label class="selectall-label"><input type="checkbox" id="canaldis-select-all" checked> Tout Canal DIS</label>
    <div id="canaldisList"></div>
  </div>
</div>

<div id="map"></div>

<div id="sidebar-right">
  <button class="toggle-btn" data-target="departement">Département</button>
  <div id="filter-departement" class="hidden">
    <label class="selectall-label"><input type="checkbox" id="departement-select-all" checked> Tout Départements</label>
    <div id="departementList"></div>
  </div>

  <button class="toggle-btn" data-target="texte2">god</button>
  <div id="filter-texte2" class="hidden">
    <label class="selectall-label"><input type="checkbox" id="texte2-select-all" checked> Tout Texte2</label>
    <div id="texte2List"></div>
  </div>
</div>

<script>
var map=L.map('map',{minZoom:6,center:[46.6,2.4],zoom:6});
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:18,attribution:'© OpenStreetMap contributors'}).addTo(map);

let extraProperties={}, geoLayer;
let distinctValues={region:new Map(), agence:new Map(), antenne:new Map(), dsp:new Map(), canaldis:new Map(), departement:new Map(), texte2:new Map()};
let filterState={region:new Map(), agence:new Map(), antenne:new Map(), dsp:new Map(), canaldis:new Map(), departement:new Map(), texte2:new Map()};

function getKeyIgnoreCase(obj,key){ key=key.toLowerCase().replace(/\s+/g,''); for(const k in obj) if(k.toLowerCase().replace(/\s+/g,'')===key) return obj[k]; return null; }

function buildFilterList(filterName, containerId){
  const container=document.getElementById(containerId);
  container.innerHTML='';

  const activeVals=[], inactiveVals=[];
  distinctValues[filterName].forEach((cpSet,val)=>{
    const isChecked=filterState[filterName].get(val)!==false;
    (isChecked?activeVals:inactiveVals).push(val);
  });

  activeVals.sort((a,b)=>a.localeCompare(b,undefined,{numeric:true,sensitivity:'base'}));
  inactiveVals.sort((a,b)=>a.localeCompare(b,undefined,{numeric:true,sensitivity:'base'}));
  const sortedVals=[...activeVals,...inactiveVals];

  sortedVals.forEach(val=>{
    const label=document.createElement('label');
    const checkbox=document.createElement('input');
    checkbox.type='checkbox';
    if(!filterState[filterName].has(val)) filterState[filterName].set(val,true);
    checkbox.checked=filterState[filterName].get(val)!==false;

    // Disable according to hierarchy
    let isDisabled=false;
    if(filterName==='agence'){
      const cpSet=distinctValues[filterName].get(val)||new Set();
      cpSet.forEach(cp=>{ const extras=extraProperties[cp]||{}; const r=getKeyIgnoreCase(extras,'région')||''; if(filterState.region.get(r)===false) isDisabled=true; });
    }
    if(filterName==='antenne'){
      const cpSet=distinctValues[filterName].get(val)||new Set();
      cpSet.forEach(cp=>{ const extras=extraProperties[cp]||{}; const a=getKeyIgnoreCase(extras,'Agence')||''; if(filterState.agence.get(a)===false) isDisabled=true; });
    }
    if(filterName==='dsp'){
      const cpSet=distinctValues[filterName].get(val)||new Set();
      cpSet.forEach(cp=>{ const extras=extraProperties[cp]||{}; const an=getKeyIgnoreCase(extras,'Antenne')||''; if(filterState.antenne.get(an)===false) isDisabled=true; });
    }
    checkbox.disabled=isDisabled;
    if(isDisabled) label.classList.add('disabled'); else label.classList.remove('disabled');

    checkbox.addEventListener('change',()=>{
      filterState[filterName].set(val,checkbox.checked);
      filterGeoLayer();
      updateSelectAllCheckbox(filterName);
      buildFilterList(filterName,containerId);
    });

    label.appendChild(checkbox);
    label.appendChild(document.createTextNode(' '+val));
    container.appendChild(label);
  });
}

// --- reste du code: updateSelectAllCheckbox, setupSelectAllListener, syncFilters, filterGeoLayer, updateMapWithExtraProperties, buildFilterLists, convertBtn ---
