<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Carte interactive codes postaux France</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    html,body{margin:0;padding:0;height:100%;font-family:Arial,Helvetica,sans-serif;overflow:hidden}
    body{display:flex;height:100vh}
    #sidebar-left,#sidebar-right{background:#000;color:#fff;padding:10px;overflow:auto;min-width:180px;max-width:380px}
    #sidebar-left{border-right:1px solid #444;width:260px}
    #sidebar-right{border-left:1px solid #444;width:260px}
    #map{flex:1;height:100vh}
    label{display:block;margin:4px 0;color:#fff;cursor:pointer}
    label.disabled{color:#777;cursor:default}
    .selectall-label{font-weight:bold;border-bottom:1px solid #444;padding-bottom:4px;margin-bottom:6px}
    .toggle-btn{width:100%;margin:8px 0;padding:6px;border-radius:6px;background:#007bff;color:#fff;border:0;text-align:left;cursor:pointer}
    #controls{position:sticky;top:0;background:#111;padding:8px;border-bottom:1px solid #444;margin-bottom:8px}
    .hidden{display:none!important}
  </style>
</head>
<body>

<button id="toggleLeftBtn" style="position:fixed;left:10px;top:10px;z-index:1300;padding:8px 12px;background:#00bfff;border-radius:6px;color:#fff;border:0;cursor:pointer">Réseau</button>
<button id="toggleRightBtn" style="position:fixed;right:10px;top:10px;z-index:1300;padding:8px 12px;background:#00bfff;border-radius:6px;color:#fff;border:0;cursor:pointer">Département</button>

<div id="sidebar-left">
  <div id="controls">
    <input id="uploadExcel" type="file" accept=".xlsx" />
    <!-- Bouton "Conversion JSON et affichage" retiré pour conversion automatique -->
  </div>

  <button class="toggle-btn" data-target="region">Région</button>
  <div id="filter-region" class="hidden">
    <label class="selectall-label"><input id="region-select-all" type="checkbox" checked> Tout Régions</label>
    <div id="regionList"></div>
  </div>

  <button class="toggle-btn" data-target="agence">Agence</button>
  <div id="filter-agence" class="hidden">
    <label class="selectall-label"><input id="agence-select-all" type="checkbox" checked> Tout Agences</label>
    <div id="agenceList"></div>
  </div>

  <button class="toggle-btn" data-target="antenne">Antenne</button>
  <div id="filter-antenne" class="hidden">
    <label class="selectall-label"><input id="antenne-select-all" type="checkbox" checked> Tout Antennes</label>
    <div id="antenneList"></div>
  </div>

  <button class="toggle-btn" data-target="dsp">DSP</button>
  <div id="filter-dsp" class="hidden">
    <label class="selectall-label"><input id="dsp-select-all" type="checkbox" checked> Tout DSP</label>
    <div id="dspList"></div>
  </div>

  <button class="toggle-btn" data-target="canaldis">Canal DIS (indépendant)</button>
  <div id="filter-canaldis" class="hidden">
    <label class="selectall-label"><input id="canaldis-select-all" type="checkbox" checked> Tout Canal DIS</label>
    <div id="canaldisList"></div>
  </div>
</div>

<div id="map"></div>

<div id="sidebar-right">
  <button class="toggle-btn" data-target="departement">Département (indépendant)</button>
  <div id="filter-departement" class="hidden">
    <label class="selectall-label"><input id="departement-select-all" type="checkbox" checked> Tout Départements</label>
    <div id="departementList"></div>
  </div>

  <button class="toggle-btn" data-target="texte2">Texte2 (indépendant)</button>
  <div id="filter-texte2" class="hidden">
    <label class="selectall-label"><input id="texte2-select-all" type="checkbox" checked> Tout Texte2</label>
    <div id="texte2List"></div>
  </div>

  <!-- Nouvelle case à cocher "Contour" -->
  <div style="margin-top:16px; border-top:1px solid #444; padding-top:8px;">
    <label>
      <input type="checkbox" id="contourCheckbox" checked />
      Contour
    </label>
  </div>
</div>

<script>
/* ================== Configuration & structures ================== */
const map = L.map('map',{minZoom:6,center:[46.6,2.4],zoom:6});
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:18, attribution:'© OpenStreetMap contributors'}).addTo(map);

let geoLayer = null;
let extraProperties = {}; // extraProperties[code_postal] = rowObject from Excel

const filters = ['region','agence','antenne','dsp','canaldis','departement','texte2'];
const hierarchy = ['region','agence','antenne','dsp']; // prioritaire, parents => earlier in array
const independents = ['canaldis','departement','texte2'];

let distinctValues = {
  region:new Map(), agence:new Map(), antenne:new Map(), dsp:new Map(),
  canaldis:new Map(), departement:new Map(), texte2:new Map()
};
// filterState maps value -> boolean (true = allowed)
let filterState = {
  region:new Map(), agence:new Map(), antenne:new Map(), dsp:new Map(),
  canaldis:new Map(), departement:new Map(), texte2:new Map()
};

const keyNames = {
  region: 'région',
  agence: 'Agence',
  antenne: 'Antenne',
  dsp: 'DSP',
  canaldis: 'Canal DIS',
  departement: 'Departement',
  texte2: 'Texte2'
};

/* helper: find a key in an object ignoring case/spacing */
function getKeyIgnoreCase(obj, key){
  if(!obj || typeof obj !== 'object') return null;
  const target = key.toLowerCase().replace(/\s+/g,'');
  for(const k in obj){
    if(k.toLowerCase().replace(/\s+/g,'') === target) return obj[k];
  }
  return null;
}

/* ================== Activabilité (priorités) ================== */
function isActivable(filterName, val){
  const cpSet = distinctValues[filterName].get(val) || new Set();
  if(cpSet.size === 0) return false;

  if(independents.includes(filterName)){
    return cpSet.size > 0;
  }

  const idx = hierarchy.indexOf(filterName);
  const parents = (idx > -1) ? hierarchy.slice(0, idx) : [];
  for(const cp of cpSet){
    const extras = extraProperties[cp] || {};
    let ok = true;
    for(const p of parents){
      const parentKey = keyNames[p];
      const parentVal = getKeyIgnoreCase(extras, parentKey) || '';
      if(filterState[p].has(parentVal) && filterState[p].get(parentVal) === false){
        ok = false; break;
      }
    }
    if(!ok) continue;
    for(const ind of independents){
      const indKey = keyNames[ind];
      const indVal = getKeyIgnoreCase(extras, indKey) || '';
      if(filterState[ind].has(indVal) && filterState[ind].get(indVal) === false){
        ok = false; break;
      }
    }
    if(ok) return true;
  }
  return false;
}

/* ================== Construction et tri des listes ================== */
function buildFilterList(filterName, containerId){
  const container = document.getElementById(containerId);
  container.innerHTML = '';

  const items = [];
  (distinctValues[filterName] || new Map()).forEach((cpSet, val) => {
    if(!filterState[filterName].has(val)) filterState[filterName].set(val, true);
    const checked = filterState[filterName].get(val) !== false;
    const activable = isActivable(filterName, val);
    items.push({val, checked, activable});
  });

  const groupActivable = items.filter(i => i.activable)
    .sort((a,b) => ((b.checked|0) - (a.checked|0)) || a.val.localeCompare(b.val, undefined, {numeric:true, sensitivity:'base'}));
  const groupNon = items.filter(i => !i.activable)
    .sort((a,b) => ((b.checked|0) - (a.checked|0)) || a.val.localeCompare(b.val, undefined, {numeric:true, sensitivity:'base'}));

  const sorted = [...groupActivable, ...groupNon];

  sorted.forEach(item => {
    const label = document.createElement('label');
    if(!item.activable) label.classList.add('disabled');
    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.checked = item.checked;
    checkbox.disabled = !item.activable;
    checkbox.addEventListener('change', () => {
      filterState[filterName].set(item.val, checkbox.checked);
      updateUI();
    });
    label.appendChild(checkbox);
    label.appendChild(document.createTextNode(' ' + item.val));
    container.appendChild(label);
  });
}

/* ================== Select-all behavior ================== */
let selectAllInitialized = false;
function setupSelectAllListener(filterName){
  if(selectAllInitialized && document.getElementById(filterName+'-select-all').dataset.init === '1') return;
  const selectAll = document.getElementById(filterName+'-select-all');
  if(!selectAll) return;
  selectAll.addEventListener('change', () => {
    const checked = selectAll.checked;
    const container = document.getElementById(filterName + 'List');
    if(!container) return;
    Array.from(container.querySelectorAll('input[type="checkbox"]')).forEach(cb => {
      if(cb.disabled) return;
      cb.checked = checked;
      const val = cb.nextSibling.textContent.trim();
      filterState[filterName].set(val, cb.checked);
    });
    updateSelectAllCheckbox(filterName);
    updateUI();
  });
  selectAll.dataset.init = '1';
}

/* ---------------- updateSelectAllCheckbox ---------------- */
function updateSelectAllCheckbox(filterName){
  const selectAll = document.getElementById(filterName+'-select-all');
  if(!selectAll) return;
  const allVals = Array.from(distinctValues[filterName].keys());
  if(allVals.length === 0){ selectAll.checked = false; selectAll.indeterminate = false; return; }
  const states = allVals.map(v => filterState[filterName].get(v) !== false);
  selectAll.checked = states.every(s => s === true);
  selectAll.indeterminate = states.some(s => s === true) && !selectAll.checked;
}

/* ================== Filter -> map, et mise à jour globale ================== */
function filterGeoLayer(){
  if(!geoLayer) return;
  geoLayer.eachLayer(layer => {
    const props = layer.feature.properties || {};
    const cp = props.code_postal || props.codePostal || props.code || '';
    const extras = extraProperties[cp] || {};

    const checks = {
      region: filterState.region.get( (getKeyIgnoreCase(extras, keyNames.region) || '') ) !== false,
      agence: filterState.agence.get( (getKeyIgnoreCase(extras, keyNames.agence) || '') ) !== false,
      antenne: filterState.antenne.get( (getKeyIgnoreCase(extras, keyNames.antenne) || '') ) !== false,
      dsp: filterState.dsp.get( (getKeyIgnoreCase(extras, keyNames.dsp) || '') ) !== false,
      canaldis: filterState.canaldis.get( (getKeyIgnoreCase(extras, keyNames.canaldis) || '') ) !== false,
      departement: filterState.departement.get( (getKeyIgnoreCase(extras, keyNames.departement) || '') ) !== false,
      texte2: filterState.texte2.get( (getKeyIgnoreCase(extras, keyNames.texte2) || '') ) !== false
    };

    const show = Object.values(checks).every(v => v === true);
    if(show) layer.addTo(map);
    else map.removeLayer(layer);
  });
}

/* ================== Mise à jour des styles du contour selon checkbox ================== */
function updateContourStyleOnGeoLayer(weight) {
  if(!geoLayer) return;
  geoLayer.setStyle(feature => {
    const cp = feature.properties.code_postal || feature.properties.codePostal || feature.properties.code || '';
    const extras = extraProperties[cp] || {};
    return {
      fillColor: getKeyIgnoreCase(extras,'Fond_couleur') || '#66cc66',
      color: getKeyIgnoreCase(extras,'Ligne_couleur') || '#000000',
      weight: weight,
      opacity: 1,
      fillOpacity: 0.7
    };
  });
}

/* central update: refresh map, then rebuild lists, then update selectAll states */
function updateUI(){
  filterGeoLayer();
  filters.forEach(f => buildFilterList(f, f + 'List'));
  filters.forEach(f => updateSelectAllCheckbox(f));
}

/* ================ Helpers to populate distinctValues from Excel data ================ */
function updateDistinctValues(jsonData){
  for(const k in distinctValues){ distinctValues[k].clear(); filterState[k].clear(); }
  jsonData.forEach(row => {
    const cp = (row["Code Postal"] || row["code_postal"] || row["codePostal"] || '').toString().trim();
    if(!cp) return;
    const re = getKeyIgnoreCase(row, keyNames.region) || '';
    const ag = getKeyIgnoreCase(row, keyNames.agence) || '';
    const an = getKeyIgnoreCase(row, keyNames.antenne) || '';
    const dsp = getKeyIgnoreCase(row, keyNames.dsp) || '';
    const canal = getKeyIgnoreCase(row, keyNames.canaldis) || '';
    const dep = getKeyIgnoreCase(row, keyNames.departement) || '';
    const tx2 = getKeyIgnoreCase(row, keyNames.texte2) || '';

    if(!distinctValues.region.has(re)) distinctValues.region.set(re, new Set()); distinctValues.region.get(re).add(cp);
    if(!distinctValues.agence.has(ag)) distinctValues.agence.set(ag, new Set()); distinctValues.agence.get(ag).add(cp);
    if(!distinctValues.antenne.has(an)) distinctValues.antenne.set(an, new Set()); distinctValues.antenne.get(an).add(cp);
    if(!distinctValues.dsp.has(dsp)) distinctValues.dsp.set(dsp, new Set()); distinctValues.dsp.get(dsp).add(cp);
    if(!distinctValues.canaldis.has(canal)) distinctValues.canaldis.set(canal, new Set()); distinctValues.canaldis.get(canal).add(cp);
    if(!distinctValues.departement.has(dep)) distinctValues.departement.set(dep, new Set()); distinctValues.departement.get(dep).add(cp);
    if(!distinctValues.texte2.has(tx2)) distinctValues.texte2.set(tx2, new Set()); distinctValues.texte2.get(tx2).add(cp);
  });
}

/* ================== Build initial lists & attach listeners once ================== */
function initialBuildAndListeners(){
  filters.forEach(f => buildFilterList(f, f + 'List'));
  filters.forEach(f => setupSelectAllListener(f));
  selectAllInitialized = true;

  document.querySelectorAll('.toggle-btn').forEach(btn=>{
    const tgt = btn.getAttribute('data-target');
    btn.textContent = capitalize(tgt);
    btn.addEventListener('click', ()=> {
      const el = document.getElementById('filter-'+tgt);
      if(!el) return;
      el.classList.toggle('hidden');
      btn.textContent = el.classList.contains('hidden') ? capitalize(tgt) : ('Masquer ' + capitalize(tgt));
    });
  });

  document.getElementById('toggleLeftBtn').addEventListener('click', ()=> {
    const left = document.getElementById('sidebar-left');
    left.style.display = (left.style.display === 'none') ? 'block' : 'none';
  });
  document.getElementById('toggleRightBtn').addEventListener('click', ()=> {
    const right = document.getElementById('sidebar-right');
    right.style.display = (right.style.display === 'none') ? 'block' : 'none';
  });

  // Listener case "Contour"
  const contourCheckbox = document.getElementById('contourCheckbox');
  contourCheckbox.addEventListener('change', () => {
    if(contourCheckbox.checked){
      updateContourStyleOnGeoLayer(1);
    } else {
      updateContourStyleOnGeoLayer(0);
    }
  });
}

function capitalize(s){ return s.charAt(0).toUpperCase() + s.slice(1); }

/* ================== Convert Excel -> JSON and init automatiquement ================== */
function convertAndDisplay(file) {
  if(!file){ alert('Sélectionne un fichier .xlsx'); return; }
  const reader = new FileReader();
  reader.onload = (e) => {
    const data = new Uint8Array(e.target.result);
    const workbook = XLSX.read(data, {type:'array'});
    const first = workbook.SheetNames[0];
    const sheet = workbook.Sheets[first];
    const jsonData = XLSX.utils.sheet_to_json(sheet, {defval: ''});

    extraProperties = {};
    jsonData.forEach(row => {
      const cp = (row["Code Postal"] || row["code_postal"] || row["codePostal"] || '').toString().trim();
      if(cp) extraProperties[cp] = row;
    });

    updateDistinctValues(jsonData);

    Object.keys(distinctValues).forEach(k => {
      distinctValues[k].forEach((_, val) => {
        filterState[k].set(val, true);
      });
    });

    filters.forEach(f => buildFilterList(f, f + 'List'));
    updateUI();
    updateMapWithExtraProperties();

    alert('Fichier converti et affichage initialisé.');
  };
  reader.readAsArrayBuffer(file);
}

/* ================== Load GeoJSON and add to map ================== */
function updateMapWithExtraProperties(){
  fetch('contours-codes-postaux.geojson')
    .then(r => { if(!r.ok) throw new Error('GeoJSON non chargé. Vérifie le chemin.'); return r.json(); })
    .then(data => {
      if(geoLayer) map.removeLayer(geoLayer);
      geoLayer = L.geoJSON(data, {
        style: feature => {
          const cp = feature.properties.code_postal || feature.properties.codePostal || feature.properties.code || '';
          const extras = extraProperties[cp] || {};
          const contourWeight = document.getElementById('contourCheckbox')?.checked ? 1 : 0;
          return {
            fillColor: getKeyIgnoreCase(extras,'Fond_couleur') || '#66cc66',
            color: getKeyIgnoreCase(extras,'Ligne_couleur') || '#000000',
            weight: contourWeight,
            opacity: 1,
            fillOpacity: 0.7
          };
        },
        onEachFeature: (feature, layer) => {
          const cp = feature.properties.code_postal || feature.properties.codePostal || feature.properties.code || '';
          const extras = extraProperties[cp] || {};
          const parts = [];
          ['Texte1','Texte2','Texte3','Texte4'].forEach(f => { const v = getKeyIgnoreCase(extras,f); if(v) parts.push(v); });
          const tooltip = parts.join(' ');
          const police = getKeyIgnoreCase(extras,'police couleur') || '#000000';
          layer.bindTooltip(`<span style="color:${police}">${tooltip || ('Code Postal : ' + cp)}</span>`, {className:'custom-tooltip'});
          const clic = getKeyIgnoreCase(extras,'Clic URL') || '';
          if(clic && clic.trim().length) { layer.on('click', ()=> window.open(clic,'_blank')); layer.setStyle({cursor:'pointer'}); }
        }
      }).addTo(map);
      updateUI();
    })
    .catch(err => { alert(err.message); console.error(err); });
}

/* ================== Initialisation au chargement DOM ================== */
document.addEventListener('DOMContentLoaded', ()=> {
  initialBuildAndListeners();

  // Conversion auto dès sélection du fichier
  document.getElementById('uploadExcel').addEventListener('change', (event) => {
    const file = event.target.files[0];
    convertAndDisplay(file);
  });
});
</script>
</body>
</html>
